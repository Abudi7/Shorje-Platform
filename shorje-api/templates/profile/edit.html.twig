{% extends 'base.html.twig' %}

{% block title %}تعديل الملف الشخصي - شورجي{% endblock %}

{% block body %}
<style>
    /* Custom animations and styles */
    .glass {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .glass-dark {
        background: rgba(15, 23, 42, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .profile-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .profile-card:hover {
        transform: translateY(-4px);
    }
    
    .floating-action {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 50;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #10b981, #3b82f6);
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #059669, #2563eb);
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-green-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20 dark:border-slate-700/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo Section -->
                <div class="flex items-center">
                    <div class="flex items-center space-x-4">
                        <div class="h-12 w-12 bg-gradient-to-br from-emerald-500 via-blue-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                            <i class="fas fa-edit text-white text-xl relative z-10"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold gradient-text">تعديل الملف الشخصي</h1>
                            <p class="text-sm text-gray-600 dark:text-gray-400">تحديث معلوماتك الشخصية وإعداداتك</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Actions -->
                <div class="flex items-center space-x-4">
                    <a href="/home" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors px-4 py-2 rounded-xl hover:bg-white/50 dark:hover:bg-slate-800/50">
                        <i class="fas fa-home"></i>
                        <span>الرئيسية</span>
                    </a>
                    <a href="/profile" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors px-4 py-2 rounded-xl hover:bg-white/50 dark:hover:bg-slate-800/50">
                        <i class="fas fa-user"></i>
                        <span>عرض الملف</span>
                    </a>
                    <button onclick="logout()" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 font-medium transition-colors px-4 py-2 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Profile Header Card -->
        <div class="relative mb-8">
            <div class="bg-gradient-to-br from-emerald-500 via-blue-600 to-purple-700 dark:from-emerald-600 dark:via-blue-700 dark:to-purple-800 rounded-3xl overflow-hidden shadow-2xl relative">
                <!-- Animated Background -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent"></div>
                <div class="absolute top-8 right-8 w-20 h-20 bg-white/10 rounded-full blur-xl animate-pulse"></div>
                <div class="absolute bottom-8 left-8 w-32 h-32 bg-emerald-400/20 rounded-full blur-2xl animate-pulse"></div>
                <div class="absolute top-1/2 left-1/4 w-16 h-16 bg-blue-400/20 rounded-full blur-xl animate-pulse"></div>
                
                <div class="relative p-8">
                    <div class="flex flex-col lg:flex-row items-start lg:items-end space-y-6 lg:space-y-0 lg:space-x-8">
                        <!-- Profile Picture -->
                        <div class="relative">
                            <div class="h-40 w-40 bg-gradient-to-br from-white to-gray-100 dark:from-slate-800 dark:to-slate-700 rounded-3xl shadow-2xl border-4 border-white dark:border-slate-600 overflow-hidden backdrop-blur-sm" id="profileImageContainer">
                                <img id="profileImage" src="{{ user.getAvatarUrl() }}" 
                                     alt="صورة الملف الشخصي" 
                                     class="w-full h-full object-cover"
                                     onerror="this.src='/images/default-avatar.png'">
                            </div>
                            <button onclick="uploadProfileImage()" class="absolute -bottom-2 -right-2 w-10 h-10 bg-emerald-500 rounded-full border-4 border-white dark:border-slate-600 shadow-lg flex items-center justify-center hover:bg-emerald-600 transition-colors">
                                <i class="fas fa-camera text-white text-sm"></i>
                            </button>
                        </div>
                        
                        <!-- User Info -->
                        <div class="flex-1 text-white">
                            <h2 class="text-3xl font-bold mb-2" id="userFullName">{{ user.getFullName() }}</h2>
                            <p class="text-emerald-100 mb-4 text-lg" id="userEmail">{{ user.email }}</p>
                            <div class="flex flex-wrap items-center gap-4">
                                <div class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-2xl text-sm font-medium">
                                    <i class="fas fa-check-circle ml-2 text-emerald-300"></i>
                                    {{ user.isVerified ? 'مؤكد' : 'غير مؤكد' }}
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-2xl text-sm font-medium">
                                    <i class="fas fa-calendar ml-2 text-blue-300"></i>
                                    عضو منذ {{ user.id ? 'الآن' : 'غير محدد' }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-wrap items-center space-x-4">
                            <button onclick="uploadCoverImage()" 
                                    class="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-6 py-3 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-xl border border-white/30">
                                <i class="fas fa-camera ml-2 text-lg"></i>تغيير صورة الغلاف
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Profile Information -->
            <div class="lg:col-span-2">
                <div class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/20 p-8 profile-card">
                    <div class="flex items-center mb-8">
                        <div class="h-12 w-12 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-2xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-user-edit text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                                تعديل الملف الشخصي
                            </h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400">تحديث معلوماتك الشخصية</p>
                        </div>
                    </div>
                    
                    <form id="profileForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-user ml-2 text-emerald-500"></i>الاسم الأول
                                </label>
                                <input type="text" id="firstName" name="firstName" 
                                       value="{{ user.firstName ?? '' }}"
                                       class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white placeholder-slate-500 dark:placeholder-slate-400">
                            </div>
                            
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-user ml-2"></i>الاسم الأخير
                                </label>
                                <input type="text" id="lastName" name="lastName" 
                                       value="{{ user.lastName ?? '' }}"
                                       class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white placeholder-slate-500 dark:placeholder-slate-400">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-envelope ml-2"></i>البريد الإلكتروني
                                </label>
                                <input type="email" id="email" name="email" 
                                       value="{{ user.email }}"
                                       class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white placeholder-slate-500 dark:placeholder-slate-400">
                            </div>
                            
                            <div>
                                <label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-calendar ml-2 text-emerald-500"></i>العمر
                                </label>
                                <input type="number" id="age" name="age" min="1" max="120"
                                       value="{{ user.age ?? '' }}"
                                       class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white placeholder-slate-500 dark:placeholder-slate-400">
                            </div>
                            
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-venus-mars ml-2 text-emerald-500"></i>الجنس
                                </label>
                                <select id="gender" name="gender" 
                                        class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white">
                                    <option value="">اختر الجنس</option>
                                    <option value="male" {{ user.gender == 'male' ? 'selected' : '' }}>ذكر</option>
                                    <option value="female" {{ user.gender == 'female' ? 'selected' : '' }}>أنثى</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-map-marker-alt ml-2 text-emerald-500"></i>الموقع
                            </label>
                            <input type="text" id="location" name="location" 
                                   value="{{ user.location ?? '' }}"
                                   placeholder="مثال: بغداد، العراق"
                                   class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white placeholder-slate-500 dark:placeholder-slate-400">
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-info-circle ml-1"></i>
                                أمثلة: بغداد، العراق | البصرة، العراق | أربيل، العراق
                            </p>
                        </div>

                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-phone ml-2"></i>رقم الهاتف
                            </label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" 
                                   value="{{ user.phoneNumber ?? '' }}"
                                   class="w-full px-4 py-4 border border-slate-300 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-300 bg-white/80 dark:bg-slate-700/80 backdrop-blur-sm text-slate-800 dark:text-white placeholder-slate-500 dark:placeholder-slate-400">
                        </div>

                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-user-edit ml-2"></i>نبذة شخصية
                            </label>
                            <textarea id="bio" name="bio" rows="4" 
                                      placeholder="اكتب نبذة شخصية عنك..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white/80 backdrop-blur-sm resize-none">{{ user.bio ?? '' }}</textarea>
                        </div>

                        <div class="flex justify-end space-x-4">
                            <a href="/profile" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
                                <i class="fas fa-times ml-2"></i>إلغاء
                            </a>
                            <button type="submit" class="bg-gradient-to-r from-emerald-500 to-blue-600 hover:from-emerald-600 hover:to-blue-700 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-2xl">
                                <i class="fas fa-save ml-2"></i>حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Change Password -->
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-lock ml-2 text-red-600"></i>تغيير كلمة المرور
                    </h3>
                    
                    <form id="passwordForm" class="space-y-4">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                كلمة المرور الحالية
                            </label>
                            <input type="password" id="currentPassword" name="currentPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 bg-white/80 backdrop-blur-sm">
                        </div>
                        
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                كلمة المرور الجديدة
                            </label>
                            <input type="password" id="newPassword" name="newPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 bg-white/80 backdrop-blur-sm">
                        </div>
                        
                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                تأكيد كلمة المرور
                            </label>
                            <input type="password" id="confirmPassword" name="confirmPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 bg-white/80 backdrop-blur-sm">
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-2xl">
                            <i class="fas fa-key ml-2"></i>تغيير كلمة المرور
                        </button>
                    </form>
                </div>

                <!-- Account Info -->
                <div class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/20 p-6 profile-card">
                    <div class="flex items-center mb-6">
                        <div class="h-10 w-10 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                            <i class="fas fa-info-circle text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">
                                معلومات الحساب
                            </h3>
                            <p class="text-xs text-gray-600 dark:text-gray-400">تفاصيل حسابك</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">حالة البريد الإلكتروني:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-medium {{ user.isVerified ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' }}">
                                {{ user.isVerified ? 'مؤكد' : 'غير مؤكد' }}
                            </span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">طريقة التسجيل:</span>
                            <span class="text-sm font-medium">
                                {% if user.googleId %}
                                    <i class="fab fa-google text-red-500 ml-1"></i>جوجل
                                {% elseif user.facebookId %}
                                    <i class="fab fa-facebook text-blue-500 ml-1"></i>فيسبوك
                                {% else %}
                                    <i class="fas fa-envelope text-gray-500 ml-1"></i>البريد الإلكتروني
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">تاريخ الإنشاء:</span>
                            <span class="text-sm font-medium">{{ user.id ? 'الآن' : 'غير محدد' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(this)">
<input type="file" id="coverImageInput" accept="image/*" style="display: none;" onchange="handleCoverImageUpload(this)">

<script>
// Profile form submission
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        age: document.getElementById('age').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        bio: document.getElementById('bio').value,
        location: document.getElementById('location').value,
        gender: document.getElementById('gender').value
    };
    
    showLoading();
    
    try {
        const response = await apiCall('/web/profile/update', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        showToast('تم تحديث الملف الشخصي بنجاح!', 'success');
        
        setTimeout(() => {
            window.location.href = '/profile';
        }, 1000);
        
    } catch (error) {
        showToast(error.message || 'حدث خطأ أثناء تحديث الملف الشخصي', 'error');
    } finally {
        hideLoading();
    }
});

// Password form submission
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showToast('كلمات المرور غير متطابقة', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showToast('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const response = await apiCall('/web/profile/change-password', {
            method: 'POST',
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        });
        
        showToast('تم تغيير كلمة المرور بنجاح!', 'success');
        
        // Clear form
        document.getElementById('passwordForm').reset();
        
    } catch (error) {
        showToast(error.message || 'حدث خطأ أثناء تغيير كلمة المرور', 'error');
    } finally {
        hideLoading();
    }
});

// Image upload functions
function uploadProfileImage() {
    document.getElementById('profileImageInput').click();
}

function uploadCoverImage() {
    document.getElementById('coverImageInput').click();
}

function handleProfileImageUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                showLoading();
                
                const response = await apiCall('/web/profile/upload-image', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'profile',
                        image: e.target.result
                    })
                });
                
                showToast('تم رفع صورة الملف الشخصي بنجاح!', 'success');
                
                // Update the image
                document.getElementById('profileImage').src = e.target.result;
                
            } catch (error) {
                showToast(error.message || 'حدث خطأ أثناء رفع الصورة', 'error');
            } finally {
                hideLoading();
            }
        };
        
        reader.readAsDataURL(file);
    }
}

function handleCoverImageUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                showLoading();
                
                const response = await apiCall('/web/profile/upload-image', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'cover',
                        image: e.target.result
                    })
                });
                
                showToast('تم رفع صورة الغلاف بنجاح!', 'success');
                
                // Update the cover image
                document.getElementById('coverImageContainer').style.backgroundImage = `url(${e.target.result})`;
                document.getElementById('coverImageContainer').style.backgroundSize = 'cover';
                document.getElementById('coverImageContainer').style.backgroundPosition = 'center';
                
            } catch (error) {
                showToast(error.message || 'حدث خطأ أثناء رفع الصورة', 'error');
            } finally {
                hideLoading();
            }
        };
        
        reader.readAsDataURL(file);
    }
}
</script>
{% endblock %}
