{% extends 'base.html.twig' %}

{% block title %}الرئيسية - شورجي - سوق متعدد البائعين{% endblock %}

{% block body %}
<style>
    /* Custom CSS for Modern Arabic Marketplace */
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    
    .category-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }
    
    .category-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .category-btn:hover::before {
        left: 100%;
    }
    
    .category-btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .category-btn:active {
        transform: scale(0.98);
    }
    
    #categorySlider {
        scroll-behavior: smooth;
    }
    
    /* Hero Slider Styles */
    .hero-slide {
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateX(100%);
        opacity: 0;
    }
    
    .hero-slide.active {
        transform: translateX(0);
        opacity: 1;
    }
    
    /* Product Card Hover Effects */
    .product-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .product-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(59, 130, 246, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
    }
    
    .product-card:hover::before {
        opacity: 1;
    }
    
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    /* Search Bar Animation */
    .search-container {
        position: relative;
        overflow: hidden;
    }
    
    .search-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
        transition: left 0.6s;
    }
    
    .search-container:focus-within::before {
        left: 100%;
    }
    
    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    /* Gradient Text */
    .gradient-text {
        background: linear-gradient(135deg, #22c55e, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* Pulse Animation for Loading */
    .pulse-dot {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    .pulse-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .pulse-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.1); }
    }
    
    /* Seller Card Hover */
    .seller-card {
        transition: all 0.3s ease;
        position: relative;
    }
    
    .seller-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: inherit;
    }
    
    .seller-card:hover::after {
        opacity: 1;
    }
    
    .seller-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #22c55e, #3b82f6);
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #16a34a, #2563eb);
    }
    
    /* Glass Morphism Effect */
    .glass {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .glass-dark {
        background: rgba(15, 23, 42, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Line clamp utilities */
    .line-clamp-1 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 1;
    }
    
    .line-clamp-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
    }
    
    .line-clamp-3 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-green-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
    <!-- Modern Arabic Marketplace Header -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20 dark:border-slate-700/30">
        <!-- Top Promotional Bar -->
        <div class="bg-gradient-to-r from-emerald-600 via-blue-600 to-purple-600 text-white text-center py-3 text-sm relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-pulse"></div>
            <div class="max-w-7xl mx-auto px-4 relative">
                <div class="flex items-center justify-center space-x-4">
                    <span class="font-bold text-lg animate-bounce">🎉</span>
                    <span class="font-bold">بيع واشتري من جيرانك المحليين</span>
                    <span class="mx-4 text-white/80">•</span>
                    <span>💬 تواصل مباشر مع البائعين</span>
                    <span class="font-bold text-lg animate-bounce">🎉</span>
                </div>
            </div>
        </div>
        
        <!-- Main Header -->
        <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <!-- Logo Section -->
                    <div class="flex items-center">
                        <div class="flex items-center space-x-4">
                            <div class="h-12 w-12 bg-gradient-to-br from-emerald-500 via-blue-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg relative overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                <i class="fas fa-store text-white text-xl relative z-10"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold gradient-text">شورجي</h1>
                                <p class="text-sm text-gray-600 dark:text-gray-400">سوق متعدد البائعين</p>
                            </div>
                        </div>
                    </div>


                    <!-- User Actions -->
                    <div class="flex items-center space-x-4">
                        {% if user %}
                        <!-- User Profile Dropdown -->
                        <div class="relative" id="userDropdown">
                            <button onclick="toggleUserDropdown()" class="flex items-center space-x-3 bg-gradient-to-r from-gray-100 to-gray-200 dark:from-slate-700 dark:to-slate-600 px-4 py-2 rounded-2xl hover:from-gray-200 hover:to-gray-300 dark:hover:from-slate-600 dark:hover:to-slate-500 transition-all duration-300 shadow-lg">
                                <div class="h-10 w-10 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-full flex items-center justify-center overflow-hidden shadow-lg">
                                    <img src="{{ user.getAvatarUrl() }}" 
                                         alt="{{ user.getFullName() }}" 
                                         class="w-full h-full object-cover"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <i class="fas fa-user text-white text-sm" style="display: none;"></i>
                                </div>
                                <div class="text-right hidden md:block">
                                    <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ user.getFullName() }}</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">مرحباً بك</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-600 dark:text-gray-400 transition-transform duration-300" id="dropdownArrow"></i>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="userDropdownMenu" class="absolute top-full right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-slate-600 opacity-0 invisible scale-95 transition-all duration-300 z-50">
                                <div class="p-4 border-b border-gray-200 dark:border-slate-600">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-12 w-12 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-full flex items-center justify-center overflow-hidden">
                                            <img src="{{ user.getAvatarUrl() }}" 
                                                 alt="{{ user.getFullName() }}" 
                                                 class="w-full h-full object-cover"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-900 dark:text-white">{{ user.getFullName() }}</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ user.email }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-2">
                                    <a href="/profile" class="flex items-center space-x-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-xl transition-colors">
                                        <i class="fas fa-user text-gray-500"></i>
                                        <span>{{ 'navigation.profile'|trans }}</span>
                                    </a>
                                    <a href="/products/my" class="flex items-center space-x-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-xl transition-colors">
                                        <i class="fas fa-box text-gray-500"></i>
                                        <span>{{ 'navigation.my_products'|trans }}</span>
                                    </a>
                                    <a href="/saved" class="flex items-center space-x-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-xl transition-colors">
                                        <i class="fas fa-heart text-gray-500"></i>
                                        <span>{{ 'navigation.saved'|trans }}</span>
                                    </a>
                                    <hr class="my-2 border-gray-200 dark:border-slate-600">
                                    <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>{{ 'navigation.logout'|trans }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Guest Actions -->
                        <div class="flex items-center space-x-3">
                            <a href="/login" class="text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium px-4 py-2 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-700 transition-all duration-300">
                                <i class="fas fa-sign-in-alt ml-2"></i>{{ 'navigation.login'|trans }}
                            </a>
                            <a href="/register" class="bg-gradient-to-r from-emerald-500 to-blue-500 text-white px-6 py-2 rounded-xl font-medium hover:from-emerald-600 hover:to-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl">
                                <i class="fas fa-user-plus ml-2"></i>{{ 'navigation.register'|trans }}
                            </a>
                        </div>
                        {% endif %}
                        
                        <!-- Messages -->
                        <div class="relative">
                            <button onclick="openMessages()" class="relative p-2 text-gray-600 hover:text-primary-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 rounded-lg">
                                <i class="fas fa-comments text-xl"></i>
                                <span id="messagesCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                            </button>
                        </div>
                        
                        <!-- Language Switcher -->
                        <div class="relative">
                            <button onclick="toggleLanguageSwitcher()" class="relative p-2 text-gray-600 hover:text-primary-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 rounded-lg" title="تغيير اللغة">
                                <i class="fas fa-globe text-xl"></i>
                            </button>
                            
                            <!-- Language Dropdown -->
                            <div id="languageDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-gray-200 dark:border-slate-600 z-50 hidden">
                                <div class="py-2">
                                    <a href="/language/ar" class="flex items-center space-x-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                                        <span class="text-2xl">🇸🇦</span>
                                        <span>العربية</span>
                                    </a>
                                    <a href="/language/en" class="flex items-center space-x-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                                        <span class="text-2xl">🇺🇸</span>
                                        <span>English</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Dropdown -->
                        {% include 'components/notification_dropdown.html.twig' %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-t border-gray-200/50 dark:border-slate-600/50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between py-4">
                    <div class="flex items-center space-x-8">
                        <a href="/home" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors">
                            <i class="fas fa-home"></i>
                            <span>{{ 'navigation.home'|trans }}</span>
                        </a>
                        <a href="/products" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors">
                            <i class="fas fa-th-large"></i>
                            <span>{{ 'navigation.products'|trans }}</span>
                        </a>
                        <a href="/users" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors">
                            <i class="fas fa-users"></i>
                            <span>{{ 'navigation.sellers'|trans }}</span>
                        </a>
                        <a href="/products/my" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors">
                            <i class="fas fa-box text-purple-500"></i>
                            <span>{{ 'navigation.my_products'|trans }}</span>
                        </a>
                        <a href="/help" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors">
                            <i class="fas fa-question-circle text-orange-500"></i>
                            <span>{{ 'navigation.how_it_works'|trans }}</span>
                        </a>
                        <a href="/contact" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 font-medium transition-colors">
                            <i class="fas fa-envelope text-green-500"></i>
                            <span>{{ 'navigation.contact'|trans }}</span>
                        </a>
                        {% if app.user and 'ROLE_SUPER_ADMIN' in app.user.roles %}
                        <a href="/admin" class="flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 font-medium transition-colors bg-red-50 dark:bg-red-900/20 px-3 py-2 rounded-lg">
                            <i class="fas fa-crown text-red-500"></i>
                            <span>لوحة التحكم</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Slider Section -->
    <section class="relative overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <!-- Hero Slider Container -->
            <div class="relative bg-gradient-to-br from-slate-900 via-blue-900 to-purple-900 rounded-3xl overflow-hidden shadow-2xl">
                <!-- Slider Slides -->
                <div class="relative h-96 md:h-[500px]">
                    {% if sliderImages|length > 0 %}
                        {% for sliderImage in sliderImages %}
                            <div class="hero-slide {% if loop.first %}active{% endif %} absolute inset-0 flex items-center">
                                {% if sliderImage.image %}
                                    <div class="absolute inset-0 bg-cover bg-center bg-no-repeat" style="background-image: url('data:{{ sliderImage.imageMimeType }};base64,{{ sliderImage.image }}');">
                                        <div class="absolute inset-0 bg-gradient-to-r from-black/50 via-black/30 to-black/50"></div>
                                    </div>
                                {% else %}
                                    <div class="absolute inset-0 bg-gradient-to-r from-slate-600/20 via-blue-600/20 to-purple-600/20"></div>
                                {% endif %}
                                <div class="relative z-10 max-w-7xl mx-auto px-8 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                                    <div class="text-white">
                                        {% if sliderImage.title %}
                                            <div class="inline-flex items-center bg-white/10 backdrop-blur-sm rounded-full px-4 py-2 mb-6">
                                                <span class="text-2xl ml-2">🎉</span>
                                                <span class="text-sm font-medium">{{ sliderImage.title }}</span>
                                            </div>
                                        {% endif %}
                                        <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
                                            {% if sliderImage.title %}{{ sliderImage.title }}{% else %}مرحباً بك في شورجي{% endif %}
                                        </h1>
                                        {% if sliderImage.description %}
                                            <p class="text-xl text-blue-100 mb-8 max-w-2xl leading-relaxed">
                                                {{ sliderImage.description }}
                                            </p>
                                        {% endif %}
                                        <div class="flex flex-col sm:flex-row gap-4">
                                            {% if sliderImage.buttonText and sliderImage.buttonUrl %}
                                                <a href="{{ sliderImage.buttonUrl }}" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 text-white px-8 py-4 rounded-2xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 shadow-xl">
                                                    <i class="fas fa-arrow-left ml-2"></i>
                                                    {{ sliderImage.buttonText }}
                                                </a>
                                            {% endif %}
                                            {% if sliderImage.buttonText2 and sliderImage.buttonUrl2 %}
                                                <a href="{{ sliderImage.buttonUrl2 }}" class="bg-white/10 backdrop-blur-sm border border-white/20 text-white px-8 py-4 rounded-2xl font-semibold text-lg hover:bg-white/20 transition-all duration-300">
                                                    <i class="fas fa-arrow-left ml-2"></i>
                                                    {{ sliderImage.buttonText2 }}
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="hidden lg:block">
                                        <div class="relative">
                                            {% if sliderImage.image %}
                                                <div class="w-80 h-80 mx-auto bg-cover bg-center bg-no-repeat rounded-3xl shadow-2xl" style="background-image: url('data:{{ sliderImage.imageMimeType }};base64,{{ sliderImage.image }}');"></div>
                                            {% else %}
                                                <div class="w-80 h-80 mx-auto bg-gradient-to-br from-emerald-500/20 to-blue-500/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                                    <i class="fas fa-store text-white text-8xl"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- Default slide when no slider images -->
                        <div class="hero-slide active absolute inset-0 flex items-center">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-600/20 via-blue-600/20 to-purple-600/20"></div>
                            <div class="relative z-10 max-w-7xl mx-auto px-8 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                                <div class="text-white">
                                    <div class="inline-flex items-center bg-white/10 backdrop-blur-sm rounded-full px-4 py-2 mb-6">
                                        <span class="text-2xl ml-2">🎉</span>
                                        <span class="text-sm font-medium">{{ 'app.welcome'|trans }}</span>
                                    </div>
                                    <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
                                        {{ 'app.hero_title'|trans }}
                                        <span class="block text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-blue-400">
                                            {{ 'app.hero_subtitle'|trans }}
                                        </span>
                                    </h1>
                                    <p class="text-xl text-blue-100 mb-8 max-w-2xl leading-relaxed">
                                        {{ 'app.hero_description'|trans }}
                                    </p>
                                    <div class="flex flex-col sm:flex-row gap-4">
                                        <button onclick="goToMyProducts()" class="bg-white/10 backdrop-blur-sm text-white px-8 py-4 rounded-2xl font-bold text-lg hover:bg-white/20 transition-all duration-300 border border-white/20">
                                            <i class="fas fa-plus ml-2"></i>بيع منتجك
                                        </button>
                                    </div>
                                </div>
                                <div class="hidden lg:block">
                                    <div class="relative">
                                        <div class="w-80 h-80 mx-auto bg-gradient-to-br from-emerald-400/20 to-blue-400/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                            <i class="fas fa-store text-8xl text-white/80"></i>
                                        </div>
                                        <div class="absolute -top-4 -right-4 w-24 h-24 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-lg">
                                            <i class="fas fa-star text-white text-2xl"></i>
                                        </div>
                                        <div class="absolute -bottom-4 -left-4 w-20 h-20 bg-gradient-to-br from-pink-400 to-red-500 rounded-full flex items-center justify-center shadow-lg">
                                            <i class="fas fa-heart text-white text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Slider Navigation -->
                <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-4">
                    {% if sliderImages|length > 0 %}
                        {% for sliderImage in sliderImages %}
                            <button onclick="changeSlide({{ loop.index0 }})" class="slider-dot {% if loop.first %}active{% endif %} w-4 h-4 bg-white rounded-full shadow-lg transition-all duration-300"></button>
                        {% endfor %}
                    {% else %}
                        <button onclick="changeSlide(0)" class="slider-dot active w-4 h-4 bg-white rounded-full shadow-lg transition-all duration-300"></button>
                    {% endif %}
                </div>

                <!-- Navigation Arrows -->
                <button onclick="previousSlide()" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/10 backdrop-blur-sm text-white p-3 rounded-full hover:bg-white/20 transition-all duration-300">
                    <i class="fas fa-chevron-right text-xl"></i>
                </button>
                <button onclick="nextSlide()" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/10 backdrop-blur-sm text-white p-3 rounded-full hover:bg-white/20 transition-all duration-300">
                    <i class="fas fa-chevron-left text-xl"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- Category Filters Section -->
    <section class="py-12 bg-gradient-to-br from-white via-blue-50/30 to-emerald-50/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Section Header -->
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
                    تصفح حسب
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-blue-500">الفئات</span>
                </h2>
                <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                    اكتشف المنتجات والخدمات المتنوعة من مختلف الفئات
                </p>
            </div>

            <!-- Category Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6 mb-12">
                <!-- All Categories -->
                <button onclick="filterByCategory('all')" 
                        class="category-card group bg-gradient-to-br from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" 
                        data-category="all">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-white/30 transition-colors">
                            <i class="fas fa-th-large text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg">الكل</h3>
                        <p class="text-sm opacity-90 mt-1">جميع الفئات</p>
                    </div>
                </button>

                <!-- Cars -->
                <button onclick="filterByCategory('car')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-blue-50 hover:to-cyan-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="car">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-cyan-100 dark:from-blue-900 dark:to-cyan-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-blue-200 group-hover:to-cyan-200 dark:group-hover:from-blue-800 dark:group-hover:to-cyan-800 transition-colors">
                            <i class="fas fa-car text-2xl text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">سيارات</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">مركبات للبيع</p>
                    </div>
                </button>

                <!-- Electronics -->
                <button onclick="filterByCategory('electronics')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-purple-50 hover:to-pink-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="electronics">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-purple-200 group-hover:to-pink-200 dark:group-hover:from-purple-800 dark:group-hover:to-pink-800 transition-colors">
                            <i class="fas fa-microchip text-2xl text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">إلكترونيات</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">أجهزة وتقنيات</p>
                    </div>
                </button>

                <!-- Fashion -->
                <button onclick="filterByCategory('fashion')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-pink-50 hover:to-rose-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="fashion">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-pink-100 to-rose-100 dark:from-pink-900 dark:to-rose-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-pink-200 group-hover:to-rose-200 dark:group-hover:from-pink-800 dark:group-hover:to-rose-800 transition-colors">
                            <i class="fas fa-tshirt text-2xl text-pink-600 dark:text-pink-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">أزياء</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ملابس وإكسسوارات</p>
                    </div>
                </button>

                <!-- Home Rental -->
                <button onclick="filterByCategory('home_rental')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-orange-50 hover:to-amber-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="home_rental">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-orange-100 to-amber-100 dark:from-orange-900 dark:to-amber-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-orange-200 group-hover:to-amber-200 dark:group-hover:from-orange-800 dark:group-hover:to-amber-800 transition-colors">
                            <i class="fas fa-home text-2xl text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">إيجار منازل</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">عقارات سكنية</p>
                    </div>
                </button>

                <!-- Jobs -->
                <button onclick="filterByCategory('job')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-indigo-50 hover:to-blue-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="job">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-100 to-blue-100 dark:from-indigo-900 dark:to-blue-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-indigo-200 group-hover:to-blue-200 dark:group-hover:from-indigo-800 dark:group-hover:to-blue-800 transition-colors">
                            <i class="fas fa-briefcase text-2xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">وظائف</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">فرص عمل</p>
                    </div>
                </button>

                <!-- Furniture -->
                <button onclick="filterByCategory('furniture')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-teal-50 hover:to-cyan-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="furniture">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-teal-100 to-cyan-100 dark:from-teal-900 dark:to-cyan-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-teal-200 group-hover:to-cyan-200 dark:group-hover:from-teal-800 dark:group-hover:to-cyan-800 transition-colors">
                            <i class="fas fa-couch text-2xl text-teal-600 dark:text-teal-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">أثاث</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">مفروشات منزلية</p>
                    </div>
                </button>

                <!-- Sports -->
                <button onclick="filterByCategory('sports')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-green-50 hover:to-emerald-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="sports">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900 dark:to-emerald-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-green-200 group-hover:to-emerald-200 dark:group-hover:from-green-800 dark:group-hover:to-emerald-800 transition-colors">
                            <i class="fas fa-futbol text-2xl text-green-600 dark:text-green-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">رياضة</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">معدات رياضية</p>
                    </div>
                </button>

                <!-- Books -->
                <button onclick="filterByCategory('books')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-amber-50 hover:to-yellow-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="books">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-amber-100 to-yellow-100 dark:from-amber-900 dark:to-yellow-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-amber-200 group-hover:to-yellow-200 dark:group-hover:from-amber-800 dark:group-hover:to-yellow-800 transition-colors">
                            <i class="fas fa-book text-2xl text-amber-600 dark:text-amber-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">كتب</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">مطبوعات ومراجع</p>
                    </div>
                </button>

                <!-- Laptop -->
                <button onclick="filterByCategory('laptop')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-gray-50 hover:to-slate-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="laptop">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-slate-100 dark:from-gray-900 dark:to-slate-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-gray-200 group-hover:to-slate-200 dark:group-hover:from-gray-800 dark:group-hover:to-slate-800 transition-colors">
                            <i class="fas fa-laptop text-2xl text-gray-600 dark:text-gray-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">لابتوب</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">أجهزة كمبيوتر</p>
                    </div>
                </button>

                <!-- Other -->
                <button onclick="filterByCategory('other')" 
                        class="category-card group bg-white dark:bg-slate-800 hover:bg-gradient-to-br hover:from-slate-50 hover:to-gray-50 dark:hover:from-slate-700 dark:hover:to-slate-600 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-gray-200 dark:border-slate-600" 
                        data-category="other">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-slate-100 to-gray-100 dark:from-slate-900 dark:to-gray-900 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:from-slate-200 group-hover:to-gray-200 dark:group-hover:from-slate-800 dark:group-hover:to-gray-800 transition-colors">
                            <i class="fas fa-ellipsis-h text-2xl text-slate-600 dark:text-slate-400"></i>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">أخرى</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">فئات متنوعة</p>
                    </div>
                </button>
            </div>
        </div>
    </section>

    <!-- Products Section -->
    <section id="products-section" class="py-12 bg-gradient-to-br from-gray-50 via-white to-blue-50/30 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Section Header -->
            <div class="flex flex-col lg:flex-row items-center justify-between mb-8">
                <div class="mb-6 lg:mb-0">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                        المنتجات المميزة
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">اكتشف أفضل المنتجات من بائعين موثوقين</p>
                </div>
                
                <!-- Advanced Search and Filters -->
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full lg:w-auto">
                    <!-- Search Input -->
                    <div class="relative w-full sm:w-80">
                        <input type="text" id="searchInput" placeholder="ابحث عن منتج أو بائع..."
                               class="w-full px-4 py-3 pl-12 pr-4 border-2 border-gray-200 dark:border-slate-600 rounded-2xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-slate-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 transition-all duration-300 shadow-lg">
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Filter Button -->
                    <button onclick="toggleAdvancedFilters()" class="bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-2xl hover:bg-gray-50 dark:hover:bg-slate-700 transition-all duration-300 shadow-lg flex items-center space-x-2">
                        <i class="fas fa-filter"></i>
                        <span>فلاتر</span>
                    </button>
                </div>
            </div>

            <!-- Advanced Filters Panel -->
            <div id="advancedFilters" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-200 dark:border-slate-600 p-6 mb-8 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Category Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-th-large ml-2"></i>الفئة
                        </label>
                        <select id="categoryFilter" class="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-slate-800 text-gray-900 dark:text-white">
                            <option value="">جميع الفئات</option>
                            <option value="car">🚗 سيارات</option>
                            <option value="home_rental">🏠 إيجار منازل</option>
                            <option value="apartment_rental">🏢 إيجار شقق</option>
                            <option value="job">💼 وظائف</option>
                            <option value="laptop">💻 لابتوب</option>
                            <option value="electronics">📱 إلكترونيات</option>
                            <option value="fashion">👕 أزياء</option>
                            <option value="furniture">🪑 أثاث</option>
                            <option value="books">📚 كتب</option>
                            <option value="sports">⚽ رياضة</option>
                            <option value="other">📦 أخرى</option>
                        </select>
                    </div>
                    
                    <!-- City Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-map-marker-alt ml-2"></i>المدينة
                        </label>
                        <select id="cityFilter" class="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-slate-800 text-gray-900 dark:text-white">
                            <option value="">جميع المدن</option>
                            <option value="بغداد">بغداد</option>
                            <option value="البصرة">البصرة</option>
                            <option value="الموصل">الموصل</option>
                            <option value="أربيل">أربيل</option>
                            <option value="كربلاء">كربلاء</option>
                            <option value="النجف">النجف</option>
                            <option value="كركوك">كركوك</option>
                            <option value="الرمادي">الرمادي</option>
                            <option value="الفلوجة">الفلوجة</option>
                            <option value="تكريت">تكريت</option>
                        </select>
                    </div>
                    
                    <!-- Price Range -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-dollar-sign ml-2"></i>نطاق السعر
                        </label>
                        <div class="flex space-x-2">
                            <input type="number" id="minPrice" placeholder="من" min="0"
                                   class="flex-1 px-3 py-3 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-slate-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400">
                            <input type="number" id="maxPrice" placeholder="إلى" min="0"
                                   class="flex-1 px-3 py-3 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-slate-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400">
                        </div>
                    </div>
                    
                    <!-- Sort By -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-sort ml-2"></i>ترتيب حسب
                        </label>
                        <select id="sortBy" class="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-slate-800 text-gray-900 dark:text-white">
                            <option value="newest">الأحدث</option>
                            <option value="oldest">الأقدم</option>
                            <option value="price_low">السعر: من الأقل للأعلى</option>
                            <option value="price_high">السعر: من الأعلى للأقل</option>
                            <option value="popular">الأكثر شعبية</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filter Actions -->
                <div class="flex justify-end space-x-4 mt-6">
                    <button onclick="clearFilters()" class="px-6 py-3 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-200 dark:hover:bg-slate-600 transition-all duration-300">
                        <i class="fas fa-times ml-2"></i>مسح الفلاتر
                    </button>
                    <button onclick="applyFilters()" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-blue-500 text-white rounded-xl hover:from-emerald-600 hover:to-blue-600 transition-all duration-300 shadow-lg">
                        <i class="fas fa-search ml-2"></i>تطبيق الفلاتر
                    </button>
                </div>
            </div>
        </div>
    </section>


            <!-- Products Grid -->
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="col-span-full text-center py-12 hidden">
                <div class="inline-flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
                    <span class="text-gray-600 dark:text-gray-400">جاري التحميل...</span>
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="col-span-full text-center py-12 hidden">
                <div class="bg-gray-100 dark:bg-slate-700 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-search text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">لا توجد منتجات</h3>
                <p class="text-gray-500 dark:text-gray-500">لم يتم العثور على منتجات تطابق معايير البحث</p>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="col-span-full flex justify-center mt-8 hidden">
                <div class="flex items-center space-x-4">
                    <button id="prevPageBtn" onclick="previousPage()" class="bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right ml-1"></i>السابق
                    </button>
                    
                    <div id="pageNumbers" class="flex items-center space-x-2">
                        <!-- Page numbers will be generated here -->
                    </div>
                    
                    <button id="nextPageBtn" onclick="nextPage()" class="bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        التالي<i class="fas fa-chevron-left mr-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Floating Action Button -->
{% if user %}
<div class="fab">
    <button onclick="openPostProductModal()" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 text-white p-4 rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-110">
        <i class="fas fa-plus text-2xl"></i>
    </button>
</div>
{% endif %}

<!-- Post Product Modal -->
<div id="postProductModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/20 w-full max-w-4xl max-h-[95vh] overflow-y-auto mx-4">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-gray-200/50 dark:border-slate-700/50 rounded-t-3xl px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 bg-gradient-to-r from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-plus text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-white">نشر منتج جديد</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400">املأ التفاصيل أدناه لنشر منتجك</p>
                    </div>
                </div>
                <button onclick="closePostProductModal()" class="h-10 w-10 bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-xl flex items-center justify-center transition-all duration-200">
                    <i class="fas fa-times text-gray-600 dark:text-slate-400"></i>
                </button>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-8">
            <form id="postProductForm" class="space-y-8">
            <!-- Product Title & Price Section -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-blue-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-tag ml-2 text-blue-500"></i>عنوان المنتج *
                        </label>
                        <input type="text" id="productTitle" required placeholder="أدخل عنوان المنتج..."
                               class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 shadow-sm">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-dollar-sign ml-2 text-green-500"></i>السعر *
                        </label>
                        <div class="flex space-x-3">
                            <input type="number" id="productPrice" required min="0" step="0.01" placeholder="0.00"
                                   class="flex-1 px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <select id="productCurrency" class="px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 shadow-sm">
                                <option value="IQD">دينار عراقي</option>
                                <option value="USD">دولار أمريكي</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 dark:text-slate-400">أدخل السعر بالعملة المختارة</p>
                            <button type="button" onclick="convertCurrency()" class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors flex items-center">
                                <i class="fas fa-exchange-alt ml-1"></i>تحويل العملة
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description Section -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-purple-100 dark:border-slate-600">
                <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">
                    <i class="fas fa-align-right ml-2 text-purple-500"></i>وصف المنتج *
                </label>
                <textarea id="productDescription" required rows="4" placeholder="اكتب وصفاً مفصلاً عن منتجك..."
                          class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 shadow-sm resize-none"></textarea>
            </div>

            <!-- Category & Location Section -->
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-emerald-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-th-large ml-2 text-emerald-500"></i>الفئة *
                        </label>
                        <select id="productCategory" required
                                class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <option value="">اختر الفئة</option>
                            <option value="car">🚗 سيارات</option>
                            <option value="home_rental">🏠 إيجار منازل</option>
                            <option value="apartment_rental">🏢 إيجار شقق</option>
                            <option value="job">💼 وظائف</option>
                            <option value="laptop">💻 لابتوب</option>
                            <option value="electronics">📱 إلكترونيات</option>
                            <option value="fashion">👕 أزياء</option>
                            <option value="furniture">🪑 أثاث</option>
                            <option value="books">📚 كتب</option>
                            <option value="sports">⚽ رياضة</option>
                            <option value="other">📦 أخرى</option>
                        </select>
                    </div>
                
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-map-marker-alt ml-2 text-teal-500"></i>المدينة *
                        </label>
                        <select id="productCity" required
                                class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200 shadow-sm">
                        <option value="">اختر المدينة</option>
                        <option value="بغداد">بغداد</option>
                        <option value="البصرة">البصرة</option>
                        <option value="الموصل">الموصل</option>
                        <option value="أربيل">أربيل</option>
                        <option value="السليمانية">السليمانية</option>
                        <option value="دهوك">دهوك</option>
                        <option value="كركوك">كركوك</option>
                        <option value="الرمادي">الرمادي</option>
                        <option value="الفلوجة">الفلوجة</option>
                        <option value="تكريت">تكريت</option>
                        <option value="بعقوبة">بعقوبة</option>
                        <option value="كربلاء">كربلاء</option>
                        <option value="النجف">النجف</option>
                        <option value="الحلة">الحلة</option>
                        <option value="الكوت">الكوت</option>
                        <option value="الديوانية">الديوانية</option>
                        <option value="السماوة">السماوة</option>
                        <option value="الناصرية">الناصرية</option>
                        <option value="العمارة">العمارة</option>
                        <option value="الأنبار">الأنبار</option>
                        <option value="ديالى">ديالى</option>
                        <option value="واسط">واسط</option>
                        <option value="ميسان">ميسان</option>
                        <option value="ذي قار">ذي قار</option>
                        <option value="المثنى">المثنى</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Location & Details Section -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-orange-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-map-pin ml-2 text-orange-500"></i>العنوان التفصيلي *
                        </label>
                        <div class="relative">
                            <input type="text" id="productLocation" required placeholder="مثال: شارع الرشيد، حي الكرادة، بغداد"
                                   class="w-full px-4 py-4 pr-12 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <button type="button" onclick="getCurrentLocation()" 
                                    class="absolute left-3 top-1/2 transform -translate-y-1/2 text-orange-500 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300 transition-colors"
                                    title="الحصول على الموقع الحالي">
                                <i class="fas fa-map-marker-alt text-lg"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 dark:text-slate-400">أدخل العنوان التفصيلي ليظهر على خرائط جوجل</p>
                            <button type="button" onclick="getCurrentLocation()" 
                                    class="text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 px-3 py-1 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors flex items-center">
                                <i class="fas fa-crosshairs ml-1"></i>استخدام الموقع الحالي
                            </button>
                        </div>
                    </div>
                
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-palette ml-2 text-red-500"></i>اللون
                        </label>
                        <select id="productColor" class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <option value="">اختر اللون</option>
                            <option value="أبيض">⚪ أبيض</option>
                            <option value="أسود">⚫ أسود</option>
                            <option value="أحمر">🔴 أحمر</option>
                            <option value="أزرق">🔵 أزرق</option>
                            <option value="أخضر">🟢 أخضر</option>
                            <option value="أصفر">🟡 أصفر</option>
                            <option value="برتقالي">🟠 برتقالي</option>
                            <option value="بنفسجي">🟣 بنفسجي</option>
                            <option value="وردي">🩷 وردي</option>
                            <option value="بني">🟤 بني</option>
                            <option value="رمادي">🔘 رمادي</option>
                            <option value="فضي">⚪ فضي</option>
                            <option value="ذهبي">🟡 ذهبي</option>
                            <option value="نحاسي">🟤 نحاسي</option>
                            <option value="متعدد الألوان">🌈 متعدد الألوان</option>
                            <option value="أخرى">❓ أخرى</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Condition & Images Section -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-indigo-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-star ml-2 text-indigo-500"></i>حالة المنتج
                        </label>
                        <select id="productCondition" class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <option value="">اختر الحالة</option>
                            <option value="جديد">✨ جديد</option>
                            <option value="مستعمل - ممتاز">⭐ مستعمل - ممتاز</option>
                            <option value="مستعمل - جيد جداً">👍 مستعمل - جيد جداً</option>
                            <option value="مستعمل - جيد">👍 مستعمل - جيد</option>
                            <option value="مستعمل - مقبول">👌 مستعمل - مقبول</option>
                            <option value="يحتاج إصلاح">🔧 يحتاج إصلاح</option>
                            <option value="للقطع">🔨 للقطع</option>
                            <option value="مشروع">🚧 مشروع</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-images ml-2 text-purple-500"></i>صور المنتج (اختياري)
                        </label>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="aspect-square bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 group" onclick="selectImage(1)">
                                <input type="file" id="image1" accept="image/*" style="display: none;" onchange="handleImagePreview(1)">
                                <div id="image1Preview" class="text-center">
                                    <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة 1</p>
                                </div>
                            </div>
                            <div class="aspect-square bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 group" onclick="selectImage(2)">
                                <input type="file" id="image2" accept="image/*" style="display: none;" onchange="handleImagePreview(2)">
                                <div id="image2Preview" class="text-center">
                                    <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة 2</p>
                                </div>
                            </div>
                            <div class="aspect-square bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 group" onclick="selectImage(3)">
                                <input type="file" id="image3" accept="image/*" style="display: none;" onchange="handleImagePreview(3)">
                                <div id="image3Preview" class="text-center">
                                    <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة 3</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="bg-gradient-to-r from-emerald-50 to-green-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-emerald-100 dark:border-slate-600">
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button type="submit" id="submitProductBtn" class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-plus ml-2 text-lg"></i>نشر المنتج
                    </button>
                    <button type="button" onclick="closePostProductModal()" class="px-8 py-4 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-slate-300 rounded-xl font-semibold transition-all duration-300 border border-gray-200 dark:border-slate-600 flex items-center justify-center">
                        <i class="fas fa-times ml-2"></i>إلغاء
                    </button>
                </div>
            </div>
        </form>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="max-w-4xl max-h-[90vh] p-4">
        <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;
let totalProducts = 0;
let isLoading = false;

// User Dropdown Toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdownMenu');
    const arrow = document.getElementById('dropdownArrow');
    
    if (dropdown.classList.contains('opacity-0')) {
        // Show dropdown
        dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
        dropdown.classList.add('opacity-100', 'visible', 'scale-100');
        arrow.classList.add('rotate-180');
    } else {
        // Hide dropdown
        dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
        dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
        arrow.classList.remove('rotate-180');
    }
}

// Language Switcher Toggle
function toggleLanguageSwitcher() {
    const dropdown = document.getElementById('languageDropdown');
    
    if (dropdown.classList.contains('hidden')) {
        dropdown.classList.remove('hidden');
    } else {
        dropdown.classList.add('hidden');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('userDropdown');
    const dropdownMenu = document.getElementById('userDropdownMenu');
    const languageDropdown = document.getElementById('languageDropdown');
    
    if (dropdown && !dropdown.contains(event.target)) {
        dropdownMenu.classList.add('opacity-0', 'invisible', 'scale-95');
        dropdownMenu.classList.remove('opacity-100', 'visible', 'scale-100');
        document.getElementById('dropdownArrow').classList.remove('rotate-180');
    }
    
    // Close language dropdown when clicking outside
    if (languageDropdown && !languageDropdown.parentElement.contains(event.target)) {
        languageDropdown.classList.add('hidden');
    }
});

// Logout function
async function logout() {
    try {
        showLoading();
        const response = await apiCall('/api/logout', { method: 'POST' });
        
        if (response.success) {
            localStorage.removeItem('jwt_token');
            showToast('تم تسجيل الخروج بنجاح', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        } else {
            showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
        }
    } catch (error) {
        console.error('Logout error:', error);
        showToast('حدث خطأ أثناء تسجيل الخروج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Post Product Modal Functions
function openPostProductModal() {
    document.getElementById('postProductModal').classList.remove('hidden');
}

function closePostProductModal() {
    document.getElementById('postProductModal').classList.add('hidden');
    document.getElementById('postProductForm').reset();
    clearImagePreviews();
}

function selectImage(imageNumber) {
    document.getElementById(`image${imageNumber}`).click();
}

function handleImagePreview(imageNumber) {
    const file = document.getElementById(`image${imageNumber}`).files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById(`image${imageNumber}Preview`);
            preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;
        };
        reader.readAsDataURL(file);
    }
}

function clearImagePreviews() {
    for (let i = 1; i <= 3; i++) {
        const preview = document.getElementById(`image${i}Preview`);
        preview.innerHTML = `
            <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
            <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة ${i}</p>
        `;
    }
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Image Modal Functions
function openImageModal(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
}

// Post Product Form
document.getElementById('postProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    console.log('Form submission started');
    
    // Validate required fields
    const requiredFields = ['productTitle', 'productDescription', 'productPrice', 'productCategory', 'productCity', 'productLocation'];
    const missingFields = [];
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            missingFields.push(fieldId);
            field.classList.add('ring-2', 'ring-red-500');
        } else {
            field.classList.remove('ring-2', 'ring-red-500');
        }
    });
    
    if (missingFields.length > 0) {
        showToast('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    const formData = {
        title: document.getElementById('productTitle').value.trim(),
        description: document.getElementById('productDescription').value.trim(),
        price: document.getElementById('productPrice').value,
        currency: document.getElementById('productCurrency').value,
        category: document.getElementById('productCategory').value,
        city: document.getElementById('productCity').value,
        location: document.getElementById('productLocation').value.trim(),
        color: document.getElementById('productColor').value,
        condition: document.getElementById('productCondition').value
    };

    console.log('Form data:', formData);

    // Handle images
    for (let i = 1; i <= 3; i++) {
        const file = document.getElementById(`image${i}`).files[0];
        if (file) {
            console.log(`Processing image ${i}:`, file.name);
            const base64 = await fileToBase64(file);
            formData[`image${i}`] = base64;
        }
    }

    try {
        showLoading();
        console.log('Sending request to /web/products');
        
        const response = await apiCall('/web/products', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        console.log('Response received:', response);
        showToast('تم نشر المنتج بنجاح!', 'success');
        closePostProductModal();
        loadProducts(); // Reload products
    } catch (error) {
        console.error('Error submitting form:', error);
        showToast('فشل في نشر المنتج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
});

// Add click event listener to submit button for debugging
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submitProductBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('Submit button clicked');
            // Don't prevent default here, let the form handle it
        });
    }
    
    // Test if form exists
    const form = document.getElementById('postProductForm');
    if (form) {
        console.log('Form found and ready');
    } else {
        console.error('Form not found!');
    }
    
    // Set current user ID for JavaScript
    {% if user %}
    window.currentUserId = {{ user.id }};
    {% else %}
    window.currentUserId = null;
    {% endif %}
});

// Filter Functions
function applyFilters() {
    console.log('Applying filters...');
    currentPage = 1;
    loadProducts();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('cityFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    
    // Clear seller results
    const existingSellerResults = document.getElementById('sellerResults');
    if (existingSellerResults) {
        existingSellerResults.remove();
    }
    
    applyFilters();
}

// Load Products
async function loadProducts() {
    if (isLoading) return;
    
    isLoading = true;
    
    const params = new URLSearchParams({
        page: currentPage,
        limit: 12
    });

    const search = document.getElementById('searchInput')?.value || '';
    const category = document.getElementById('categoryFilter')?.value || '';
    const city = document.getElementById('cityFilter')?.value || '';
    const minPrice = document.getElementById('minPrice')?.value || '';
    const maxPrice = document.getElementById('maxPrice')?.value || '';

    console.log('Filter values:', { search, category, city, minPrice, maxPrice, selectedCategory });

    if (search) params.append('search', search);
    
    // Use selected category from slider if not 'all', otherwise use sidebar filter
    if (selectedCategory !== 'all') {
        params.append('category', selectedCategory);
    } else if (category) {
        params.append('category', category);
    }
    
    if (city) params.append('city', city);
    if (minPrice) params.append('min_price', minPrice);
    if (maxPrice) params.append('max_price', maxPrice);

    console.log('API URL:', `/api/products?${params.toString()}`);

    try {
        // Show loading indicator
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
        
        const response = await apiCall(`/web/products?${params.toString()}`);
        
        // Handle web endpoint response format
        let products = [];
        let total = 0;
        
        if (response.products && Array.isArray(response.products)) {
            // Web endpoint format
            products = response.products;
            total = response.pagination?.total || response.products.length;
        } else if (Array.isArray(response)) {
            // Direct array response
            products = response;
            total = response.length;
        } else if (response.member && Array.isArray(response.member)) {
            // JSON-LD format with member array
            products = response.member;
            total = response.totalItems || response.member.length;
        } else {
            // Fallback
            products = [];
            total = 0;
        }
        
        // Update pagination info
        totalProducts = total;
        totalPages = Math.ceil(totalProducts / 12);
        
        // Show loading state
        document.getElementById('loadingState').classList.add('hidden');
        
        window.currentProducts = products;
        renderProducts(products);
        
        // Show results count for filtered results
        const hasFilters = search || category || city || minPrice || maxPrice || selectedCategory !== 'all';
        if (hasFilters && currentPage === 1) {
            showToast(`تم العثور على ${totalProducts} منتج`, 'success');
        }
        
    } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('productsGrid').innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="text-red-500 text-lg">حدث خطأ في تحميل المنتجات</p>
                <p class="text-slate-600 dark:text-slate-400 mt-2">يرجى المحاولة مرة أخرى</p>
            </div>
        `;
        showToast('فشل في تحميل المنتجات: ' + error.message, 'error');
    } finally {
        isLoading = false;
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        loadProducts();
    }
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        loadProducts();
    }
}

function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        loadProducts();
    }
}

function updatePagination() {
    const paginationContainer = document.getElementById('pagination');
    const pageNumbersContainer = document.getElementById('pageNumbers');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (totalPages <= 1) {
        paginationContainer.classList.add('hidden');
        return;
    }
    
    paginationContainer.classList.remove('hidden');
    
    // Update prev/next buttons
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    
    // Generate page numbers
    let pageNumbers = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start page if we're near the end
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Add first page and ellipsis if needed
    if (startPage > 1) {
        pageNumbers += `
            <button onclick="goToPage(1)" class="px-3 py-2 rounded-lg font-medium transition-all duration-300 bg-white dark:bg-slate-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700">
                1
            </button>
        `;
        if (startPage > 2) {
            pageNumbers += `<span class="px-2 text-gray-500">...</span>`;
        }
    }
    
    // Add visible page numbers
    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        pageNumbers += `
            <button onclick="goToPage(${i})" class="px-3 py-2 rounded-lg font-medium transition-all duration-300 ${
                isActive 
                    ? 'bg-emerald-500 text-white' 
                    : 'bg-white dark:bg-slate-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700'
            }">
                ${i}
            </button>
        `;
    }
    
    // Add last page and ellipsis if needed
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pageNumbers += `<span class="px-2 text-gray-500">...</span>`;
        }
        pageNumbers += `
            <button onclick="goToPage(${totalPages})" class="px-3 py-2 rounded-lg font-medium transition-all duration-300 bg-white dark:bg-slate-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700">
                ${totalPages}
            </button>
        `;
    }
    
    pageNumbersContainer.innerHTML = pageNumbers;
}

function renderProducts(products) {
    const container = document.getElementById('productsGrid');
    
    // Clear existing products
    container.innerHTML = '';
    
    if (products.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('loadingState').classList.add('hidden');
        return;
    }
    
    document.getElementById('emptyState').classList.add('hidden');
    
    products.forEach(product => {
        const productElement = createProductElement(product);
        container.appendChild(productElement);
    });
    
    // Update pagination
    updatePagination();
}

function createProductElement(product) {
    const div = document.createElement('div');
    div.className = 'product-card bg-white dark:bg-slate-800 rounded-2xl shadow-lg hover:shadow-xl border border-gray-200 dark:border-slate-600 overflow-hidden transition-all duration-300 cursor-pointer hover:scale-105';
    div.onclick = function(e) {
        // Don't trigger if clicking on buttons
        if (e.target.closest('button')) return;
        // Open product details
        viewProduct(product.id);
    };
    
    // Get product images
    const images = [];
    if (product.hasImages && product.hasImages.image1) images.push(`/api/products/image/${product.id}/1`);
    if (product.hasImages && product.hasImages.image2) images.push(`/api/products/image/${product.id}/2`);
    if (product.hasImages && product.hasImages.image3) images.push(`/api/products/image/${product.id}/3`);
    
    // Create main image (first image or placeholder)
    const mainImage = images.length > 0 ? images[0] : '/placeholder-image.jpg';
    
    // Create image gallery
    const imageGallery = images.length > 1 ? `
        <div class="absolute bottom-2 left-2 flex space-x-1">
            ${images.slice(0, 3).map(() => `
                <div class="w-2 h-2 bg-white rounded-full opacity-60"></div>
            `).join('')}
            ${images.length > 3 ? `<div class="w-2 h-2 bg-white rounded-full opacity-60">+</div>` : ''}
        </div>
    ` : '';
    
    // Get category icon
    const categoryIcons = {
        'car': 'fas fa-car',
        'electronics': 'fas fa-microchip',
        'fashion': 'fas fa-tshirt',
        'furniture': 'fas fa-couch',
        'sports': 'fas fa-futbol',
        'books': 'fas fa-book',
        'laptop': 'fas fa-laptop',
        'home_rental': 'fas fa-home',
        'apartment_rental': 'fas fa-building',
        'job': 'fas fa-briefcase',
        'other': 'fas fa-box'
    };
    
    const categoryIcon = categoryIcons[product.category] || 'fas fa-box';
    
    div.innerHTML = `
        <!-- Product Image -->
        <div class="relative h-48 bg-gray-100 dark:bg-slate-700 overflow-hidden">
            <img src="${mainImage}" 
                 alt="${product.title}" 
                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300"
                 onclick="openImageModal('${mainImage}')"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMjUgNzVIMTc1VjEyNUgxMjVWNzVaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0xMzUgODVIMTY1VjExNUgxMzVWODVaIiBmaWxsPSIjNjM2NkY3Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEwMCIgcj0iNSIgZmlsbD0iIzZCNzI4MCIvPgo8dGV4dCB4PSIxNTAiIHk9IjE1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzlDQTNBRiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0Ij5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+'">
            ${imageGallery}
            
            <!-- Category Badge -->
            <div class="absolute top-3 left-3">
                <span class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full text-sm font-medium flex items-center space-x-2">
                    <i class="${categoryIcon} text-xs"></i>
                    <span>${product.categoryDisplay || product.category}</span>
                </span>
            </div>
            
            <!-- Price Badge -->
            <div class="absolute top-3 right-3">
                <span class="bg-emerald-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                    ${product.price} ${product.currencyDisplay || 'IQD'}
                </span>
            </div>
        </div>
        
        <!-- Product Content -->
        <div class="p-4">
            <!-- Product Title -->
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2 line-clamp-2">
                ${product.title}
            </h3>
            
            <!-- Product Description -->
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-3 line-clamp-2">
                ${product.description}
            </p>
            
            <!-- Seller Info -->
            <div class="flex items-center space-x-3 mb-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 p-2 rounded-lg transition-colors duration-200" onclick="event.stopPropagation(); viewProfile(${product.seller.id})" title="عرض ملف البائع">
                <div class="h-8 w-8 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-full flex items-center justify-center overflow-hidden">
                    <img src="/api/user/avatar/${product.seller.id}" 
                         alt="${product.seller.name}" 
                         class="w-full h-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-user text-white text-xs" style="display: none;"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors">${product.seller.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">${product.city}</p>
                </div>
                <span class="text-xs text-gray-500 dark:text-gray-500">${formatDate(product.createdAt)}</span>
            </div>
            
            <!-- Product Details -->
            <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-4">
                <div class="flex items-center space-x-4">
                    <span class="flex items-center space-x-1">
                        <i class="fas fa-map-marker-alt text-xs"></i>
                        <span>${product.city}</span>
                    </span>
                    ${product.condition ? `
                    <span class="flex items-center space-x-1">
                        <i class="fas fa-star text-xs"></i>
                        <span>${product.condition}</span>
                    </span>
                    ` : ''}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-2 mt-4">
                ${getProductButtons(product)}
            </div>
            
            <!-- Quick Actions for Visitors -->
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-slate-600">
                <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                    <span class="flex items-center space-x-1">
                        <i class="fas fa-eye"></i>
                        <span>انقر لعرض التفاصيل</span>
                    </span>
                    <span class="flex items-center space-x-1">
                        <i class="fas fa-user"></i>
                        <span>انقر على البائع</span>
                    </span>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function contactSeller(sellerId) {
    window.location.href = `/messages?seller=${sellerId}`;
}

// Contact seller with product details
function contactSellerWithProduct(productId, sellerId) {
    if (!sellerId || sellerId === 0) {
        showToast('معلومات البائع غير متوفرة', 'warning');
        return;
    }
    
    // Find the product details from current products
    const product = window.currentProducts?.find(p => p.id === productId);
    if (!product) {
        showToast('معلومات المنتج غير متوفرة', 'warning');
        return;
    }
    
    // Create product attachment data
    const productAttachment = {
        productId: product.id,
        productName: product.title,
        productPrice: `${product.price} ${product.currencyDisplay || product.currency}`,
        productImage: product.hasImages?.image1 ? `/api/products/image/${product.id}/1` : null,
        productCategory: product.categoryDisplay || product.category,
        productCity: product.city,
        sellerName: product.seller.name,
        productDescription: product.description
    };
    
    // Encode the product data as URL parameter
    const productData = encodeURIComponent(JSON.stringify(productAttachment));
    
    // Redirect to messages with product attachment
    window.location.href = `/messages?seller=${sellerId}&product=${productData}`;
}

// View seller profile function
function viewSellerProfile(sellerId) {
    if (!sellerId || sellerId === 0) {
        showToast('معلومات البائع غير متوفرة', 'warning');
        return;
    }
    
    // Open seller profile in a new tab
    window.open(`/profile/${sellerId}`, '_blank');
}

// View product details function
function viewProduct(productId) {
    if (!productId || productId === 0) {
        showToast('معلومات المنتج غير متوفرة', 'warning');
        return;
    }
    
    // Open product details page in a new tab
    window.open(`/products/${productId}`, '_blank');
}

// View seller profile function (unified)
function viewProfile(userId) {
    if (!userId || userId === 0) {
        showToast('معلومات المستخدم غير متوفرة', 'warning');
        return;
    }
    
    // Open profile in a new tab
    window.open(`/profile/${userId}`, '_blank');
}

// Get status badge class
function getStatusBadgeClass(status) {
    switch (status) {
        case 'available': return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200';
        case 'sold': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        case 'reserved': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        default: return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200';
    }
}

// Get status text
function getStatusText(status) {
    switch (status) {
        case 'available': return 'متاح';
        case 'sold': return 'مباع';
        case 'reserved': return 'محجوز';
        default: return 'متاح';
    }
}

function getProductButtons(product) {
    const currentUserId = getCurrentUserId();
    
    if (currentUserId && currentUserId == product.seller.id) {
        // Show edit and delete buttons for product owner
        return `
            <button onclick="editProduct(${product.id})" class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 text-sm">
                <i class="fas fa-edit ml-1"></i>تعديل
            </button>
            <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-medium transition-all duration-300 text-sm">
                <i class="fas fa-trash"></i>
            </button>
        `;
    } else {
        // Enhanced buttons for visitors - more interactive and user-friendly
        return `
            <button onclick="contactSellerWithProduct(${product.id}, ${product.seller.id})" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 text-sm shadow-lg hover:shadow-xl transform hover:scale-105">
                <i class="fas fa-comments ml-1"></i>رسالة
            </button>
            <button onclick="viewProfile(${product.seller.id})" class="px-4 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 transition-all duration-300 text-sm hover:shadow-md" title="عرض ملف البائع">
                <i class="fas fa-user"></i>
            </button>
            <button onclick="viewProduct(${product.id})" class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg transition-all duration-300 text-sm shadow-lg hover:shadow-xl transform hover:scale-105" title="عرض تفاصيل المنتج">
                <i class="fas fa-eye"></i>
            </button>
        `;
    }
}

function getCurrentUserId() {
    // This should be set from the backend when the page loads
    return window.currentUserId || null;
}

function editProduct(productId) {
    // Open edit modal or redirect to edit page
    showToast('ميزة التعديل قيد التطوير', 'info');
    // TODO: Implement edit functionality - could open a modal with pre-filled form
}

async function deleteProduct(productId) {
    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        try {
            showLoading();
            const response = await apiCall(`/api/products/${productId}`, {
                method: 'DELETE'
            });
            
            showToast('تم حذف المنتج بنجاح', 'success');
            loadProducts(); // Reload the products list
        } catch (error) {
            console.error('Error deleting product:', error);
            showToast('فشل في حذف المنتج: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
}

function openGoogleMaps(address) {
    const encodedAddress = encodeURIComponent(address);
    const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
    window.open(googleMapsUrl, '_blank');
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        showToast('المتصفح لا يدعم تحديد الموقع', 'error');
        return;
    }

    showLoading();
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            // Use reverse geocoding to get address from coordinates
            reverseGeocode(latitude, longitude);
        },
        function(error) {
            hideLoading();
            let errorMessage = 'فشل في الحصول على الموقع';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'تم رفض إذن الوصول للموقع';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'معلومات الموقع غير متاحة';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'انتهت مهلة طلب الموقع';
                    break;
            }
            
            showToast(errorMessage, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

function reverseGeocode(latitude, longitude) {
    // Using Google Geocoding API (you'll need to get an API key)
    // For now, we'll use a simple approach with OpenStreetMap Nominatim
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ar`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data && data.display_name) {
                // Extract relevant parts of the address
                let address = data.display_name;
                
                // Clean up the address for better readability
                address = address.replace(/، العراق$/, ''); // Remove "، Iraq" at the end
                address = address.replace(/، محافظة [^،]*$/, ''); // Remove governorate info
                
                // Set the address in the input field
                document.getElementById('productLocation').value = address;
                showToast('تم الحصول على الموقع بنجاح!', 'success');
            } else {
                // Fallback: use coordinates if address lookup fails
                const fallbackAddress = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                document.getElementById('productLocation').value = fallbackAddress;
                showToast('تم الحصول على الإحداثيات، يمكنك تعديل العنوان', 'info');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Geocoding error:', error);
            
            // Fallback: use coordinates
            const fallbackAddress = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            document.getElementById('productLocation').value = fallbackAddress;
            showToast('تم الحصول على الإحداثيات، يمكنك تعديل العنوان', 'info');
        });
}

function convertCurrency() {
    const priceInput = document.getElementById('productPrice');
    const currencySelect = document.getElementById('productCurrency');
    const currentPrice = parseFloat(priceInput.value);
    
    if (!currentPrice || currentPrice <= 0) {
        showToast('يرجى إدخال سعر صحيح أولاً', 'error');
        return;
    }
    
    const currentCurrency = currencySelect.value;
    let newPrice, newCurrency, message;
    
    // Exchange rate: 1 USD = 1500 IQD (approximate rate, you can update this)
    const exchangeRate = 1500;
    
    if (currentCurrency === 'IQD') {
        newPrice = (currentPrice / exchangeRate).toFixed(2);
        newCurrency = 'USD';
        message = `تم تحويل ${currentPrice} دينار عراقي إلى ${newPrice} دولار أمريكي`;
    } else {
        newPrice = (currentPrice * exchangeRate).toFixed(0);
        newCurrency = 'IQD';
        message = `تم تحويل ${currentPrice} دولار أمريكي إلى ${newPrice} دينار عراقي`;
    }
    
    priceInput.value = newPrice;
    currencySelect.value = newCurrency;
    showToast(message, 'success');
}

// Test function to manually submit form
function testFormSubmission() {
    console.log('Testing form submission...');
    
    // Fill in some test data
    document.getElementById('productTitle').value = 'Test Product';
    document.getElementById('productDescription').value = 'Test Description';
    document.getElementById('productPrice').value = '100';
    document.getElementById('productCurrency').value = 'IQD';
    document.getElementById('productCategory').value = 'other';
    document.getElementById('productCity').value = 'بغداد';
    document.getElementById('productLocation').value = 'Test Location';
    
    // Trigger form submission
    const form = document.getElementById('postProductForm');
    if (form) {
        form.dispatchEvent(new Event('submit'));
    } else {
        console.error('Form not found for testing');
    }
}

// Test function for filters
function testFilters() {
    console.log('Testing filters...');
    
    // Set some test filter values
    document.getElementById('searchInput').value = 'سيارة';
    document.getElementById('categoryFilter').value = 'car';
    document.getElementById('cityFilter').value = 'بغداد';
    document.getElementById('minPrice').value = '1000';
    document.getElementById('maxPrice').value = '50000';
    
    // Apply filters
    applyFilters();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    }) + ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// Home Page Seller Search functionality
async function searchHomeSellers(query) {
    if (query.length < 2) {
        document.getElementById('homeSellerSearchResults').innerHTML = '';
        return;
    }
    
    try {
        const response = await apiCall(`/api/search-sellers?q=${encodeURIComponent(query)}`);
        
        if (response.sellers && response.sellers.length > 0) {
            displayHomeSellerResults(response.sellers);
        } else {
            document.getElementById('homeSellerSearchResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لم يتم العثور على بائعين</p>';
        }
    } catch (error) {
        console.error('Home seller search error:', error);
        document.getElementById('homeSellerSearchResults').innerHTML = '<p class="text-red-500 text-center py-4">حدث خطأ أثناء البحث</p>';
    }
}

function displayHomeSellerResults(sellers) {
    const resultsContainer = document.getElementById('homeSellerSearchResults');
    
    const sellersHtml = sellers.map(seller => `
        <div class="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 border border-gray-200 dark:border-slate-600 hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">
            <div class="flex items-center space-x-4">
                <div class="h-12 w-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center overflow-hidden">
                    <img src="/api/profile/image/${seller.id}/profile" 
                         alt="${seller.name}" 
                         class="w-full h-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-slate-800 dark:text-white">${seller.name}</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">${seller.email}</p>
                    ${seller.isVerified ? '<span class="text-xs text-green-500"><i class="fas fa-check-circle ml-1"></i>مؤكد</span>' : ''}
                </div>
                <div class="flex space-x-2">
                    <button onclick="viewProfile(${seller.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user ml-1"></i>الملف
                    </button>
                    <button onclick="contactSeller(${seller.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-comment ml-1"></i>رسالة
                    </button>
                    <button onclick="toggleFollow(${seller.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = sellersHtml;
}

function clearHomeSearch() {
    document.getElementById('homeSellerSearchInput').value = '';
    document.getElementById('homeSellerSearchResults').innerHTML = '';
}

// Seller Search functionality (for sidebar)
async function searchSellers(query) {
    if (query.length < 2) {
        document.getElementById('sellerSearchResults').innerHTML = '';
        return;
    }
    
    try {
        const response = await apiCall(`/api/search-sellers?q=${encodeURIComponent(query)}`);
        
        if (response.sellers && response.sellers.length > 0) {
            displaySellerResults(response.sellers);
        } else {
            document.getElementById('sellerSearchResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لم يتم العثور على بائعين</p>';
        }
    } catch (error) {
        console.error('Seller search error:', error);
        document.getElementById('sellerSearchResults').innerHTML = '<p class="text-red-500 text-center py-4">حدث خطأ أثناء البحث</p>';
    }
}

function displaySellerResults(sellers) {
    const resultsContainer = document.getElementById('sellerSearchResults');
    
    const sellersHtml = sellers.map(seller => `
        <div class="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 border border-gray-200 dark:border-slate-600">
            <div class="flex items-center space-x-4">
                <div class="h-12 w-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center overflow-hidden">
                    <img src="/api/profile/image/${seller.id}/profile" 
                         alt="${seller.name}" 
                         class="w-full h-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-slate-800 dark:text-white">${seller.name}</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">${seller.email}</p>
                    ${seller.isVerified ? '<span class="text-xs text-green-500"><i class="fas fa-check-circle ml-1"></i>مؤكد</span>' : ''}
                </div>
                <div class="flex space-x-2">
                    <button onclick="viewProfile(${seller.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user ml-1"></i>الملف
                    </button>
                    <button onclick="contactSeller(${seller.id})" class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-comment ml-1"></i>رسالة
                    </button>
                    <button onclick="toggleFollow(${seller.id})" class="bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-300 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = sellersHtml;
}

// Follow/Unfollow functionality
async function toggleFollow(userId) {
    try {
        // Check current follow status
        const statusResponse = await apiCall(`/api/follow-status/${userId}`);
        
        if (!statusResponse.success) {
            showToast('فشل في جلب حالة المتابعة: ' + statusResponse.error, 'error');
            return;
        }
        
        const isFollowing = statusResponse.isFollowing;
        let response;
        
        if (isFollowing) {
            response = await apiCall(`/api/unfollow/${userId}`, { method: 'POST' });
        } else {
            response = await apiCall(`/api/follow/${userId}`, { method: 'POST' });
        }
        
        if (response.success) {
            showToast(response.message, 'success');
        } else {
            showToast(response.error || 'حدث خطأ أثناء المتابعة', 'error');
        }
        
    } catch (error) {
        console.error('Follow toggle error:', error);
        showToast(error.message || 'حدث خطأ أثناء المتابعة', 'error');
    }
}

// Category Filtering
let selectedCategory = 'all';

function filterByCategory(category) {
    selectedCategory = category;
    
        // Update button styles
        document.querySelectorAll('.category-btn').forEach(btn => {
            const btnCategory = btn.getAttribute('data-category');
            if (btnCategory === category) {
                // Active state
                btn.className = btn.className.replace('bg-white dark:bg-slate-700', 'bg-gradient-to-r from-emerald-500 to-green-600')
                    .replace('text-gray-700 dark:text-gray-300', 'text-white')
                    .replace('border-2 border-gray-200 dark:border-slate-600', '')
                    .replace('hover:bg-emerald-50 dark:hover:bg-emerald-900/20', 'hover:from-emerald-600 hover:to-green-700')
                    .replace('hover:text-emerald-600 dark:hover:text-emerald-400', '')
                    .replace('hover:border-emerald-300 dark:hover:border-emerald-600', '');
            } else {
                // Inactive state
                btn.className = btn.className.replace('bg-gradient-to-r from-emerald-500 to-green-600', 'bg-white dark:bg-slate-700')
                    .replace('text-white', 'text-gray-700 dark:text-gray-300')
                    .replace('hover:from-emerald-600 hover:to-green-700', 'hover:bg-emerald-50 dark:hover:bg-emerald-900/20')
                    .replace('hover:text-emerald-600 dark:hover:text-emerald-400', 'hover:text-emerald-600 dark:hover:text-emerald-400');
                if (!btn.className.includes('border-2')) {
                    btn.className += ' border-2 border-gray-200 dark:border-slate-600 hover:border-emerald-300 dark:hover:border-emerald-600';
                }
            }
        });
    
    // Reset pagination and load products
    currentPage = 1;
    loadProducts();
    
    // Show loading state
    showToast(`جاري تحميل منتجات ${category === 'all' ? 'الكل' : getCategoryName(category)}...`, 'info');
}

function getCategoryName(category) {
    const names = {
        'all': 'الكل',
        'car': 'سيارات',
        'home_rental': 'إيجار منازل',
        'apartment_rental': 'إيجار شقق',
        'job': 'وظائف',
        'laptop': 'لابتوب',
        'electronics': 'إلكترونيات',
        'fashion': 'أزياء',
        'furniture': 'أثاث',
        'books': 'كتب',
        'sports': 'رياضة',
        'other': 'أخرى'
    };
    return names[category] || category;
}

// Hero Slider Functions
let currentSlide = 0;
const totalSlides = {{ sliderImages|length > 0 ? sliderImages|length : 1 }};

function changeSlide(slideIndex) {
    const slides = document.querySelectorAll('.hero-slide');
    const dots = document.querySelectorAll('.slider-dot');
    
    // Remove active class from all slides and dots
    slides.forEach(slide => slide.classList.remove('active', 'opacity-100'));
    dots.forEach(dot => dot.classList.remove('active'));
    
    // Add active class to current slide and dot
    slides[slideIndex].classList.add('active', 'opacity-100');
    dots[slideIndex].classList.add('active');
    
    currentSlide = slideIndex;
}

function nextSlide() {
    currentSlide = (currentSlide + 1) % totalSlides;
    changeSlide(currentSlide);
}

function previousSlide() {
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    changeSlide(currentSlide);
}

// Auto-slide functionality
function startAutoSlide() {
    setInterval(() => {
        nextSlide();
    }, 5000); // Change slide every 5 seconds
}

// Advanced Filter Functions
function toggleAdvancedFilters() {
    const filtersPanel = document.getElementById('advancedFilters');
    filtersPanel.classList.toggle('hidden');
}

function toggleSellerFilters() {
    const sellerFiltersPanel = document.getElementById('sellerFilters');
    sellerFiltersPanel.classList.toggle('hidden');
}

function clearSellerFilters() {
    document.getElementById('sellerLocationFilter').value = '';
    document.getElementById('sellerCategoryFilter').value = '';
    document.getElementById('sellerRatingFilter').value = '';
    applySellerFilters();
}

function applySellerFilters() {
    const location = document.getElementById('sellerLocationFilter').value;
    const category = document.getElementById('sellerCategoryFilter').value;
    const rating = document.getElementById('sellerRatingFilter').value;
    
    // Apply seller filters logic here
    console.log('Applying seller filters:', { location, category, rating });
    showToast('تم تطبيق فلاتر البائعين', 'success');
}

// Category Filter Functions
function filterByCategory(category) {
    selectedCategory = category;
    
    // Update category card styles
    document.querySelectorAll('.category-card').forEach(card => {
        const cardCategory = card.getAttribute('data-category');
        if (cardCategory === category) {
            // Active state
            card.className = card.className.replace('bg-white dark:bg-slate-800', 'bg-gradient-to-br from-emerald-500 to-green-600')
                .replace('text-gray-900 dark:text-white', 'text-white')
                .replace('border border-gray-200 dark:border-slate-600', '')
                .replace('hover:bg-gradient-to-br hover:from-', 'hover:from-emerald-600 hover:to-green-700')
                .replace('hover:text-gray-900 dark:hover:text-white', '')
                .replace('hover:shadow-xl', 'hover:shadow-2xl');
            
            // Update icon colors
            const icon = card.querySelector('i');
            if (icon) {
                icon.className = icon.className.replace(/text-\w+-\d+/, 'text-white');
            }
            
            // Update text colors
            card.querySelectorAll('h3, p').forEach(text => {
                text.className = text.className.replace('text-gray-900 dark:text-white', 'text-white')
                    .replace('text-gray-600 dark:text-gray-400', 'text-white/90');
            });
        } else {
            // Reset to inactive state
            card.className = card.className.replace('bg-gradient-to-br from-emerald-500 to-green-600', 'bg-white dark:bg-slate-800')
                .replace('text-white', 'text-gray-900 dark:text-white')
                .replace('hover:from-emerald-600 hover:to-green-700', 'hover:bg-gradient-to-br hover:from-gray-50 hover:to-gray-100 dark:hover:from-slate-700 dark:hover:to-slate-600')
                .replace('hover:shadow-2xl', 'hover:shadow-xl');
            
            if (!card.className.includes('border border-gray-200 dark:border-slate-600')) {
                card.className += ' border border-gray-200 dark:border-slate-600';
            }
        }
    });
    
    // Reset pagination and load products
    currentPage = 1;
    loadProducts();
    
    // Show loading state
    showToast(`جاري تحميل منتجات ${category === 'all' ? 'الكل' : getCategoryName(category)}...`, 'info');
}

// Search for sellers function
function searchForSellers() {
    document.getElementById('mainSearchInput').value = '';
    document.getElementById('mainSearchInput').focus();
    showToast('اكتب اسم البائع في مربع البحث للعثور على البائعين', 'info');
}

// Contact seller function
function contactSeller(sellerId) {
    window.location.href = `/messages?seller=${sellerId}`;
}

// View seller profile function
function viewSellerProfile(sellerId) {
    window.location.href = `/profile/${sellerId}`;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set current user ID for JavaScript functions
    {% if user %}
    window.currentUserId = {{ user.id }};
    {% else %}
    window.currentUserId = null;
    {% endif %}
    
    // Initialize slider
    startAutoSlide();
    
    loadProducts();
    
    // Start real-time updates for messages and notifications
    startRealTimeUpdates();
    
    // Request notification permission
    requestNotificationPermission();
    
    // Test function for debugging (remove in production)
    
    
    
    // Add filter input listeners
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const cityFilter = document.getElementById('cityFilter');
    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');
    
    if (searchInput) searchInput.addEventListener('input', debounce(applyFilters, 500));
    if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
    if (cityFilter) cityFilter.addEventListener('change', applyFilters);
    if (minPrice) minPrice.addEventListener('input', debounce(applyFilters, 500));
    if (maxPrice) maxPrice.addEventListener('input', debounce(applyFilters, 500));
    
    // Add seller search listener
    const homeSellerSearchInput = document.getElementById('homeSellerSearchInput');
    if (homeSellerSearchInput) {
        homeSellerSearchInput.addEventListener('input', debounce(function(e) {
            searchHomeSellers(e.target.value);
        }, 300));
    }
    
    // Add main search listener
    const mainSearchInput = document.getElementById('mainSearchInput');
    if (mainSearchInput) {
        mainSearchInput.addEventListener('input', debounce(function(e) {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                // Perform search as you type
                console.log('Performing search for:', query);
                performMainSearch();
            } else if (query.length === 0) {
                // Clear search and show all products
                currentPage = 1;
                selectedCategory = 'all';
                // Clear seller results
                const existingSellerResults = document.getElementById('sellerResults');
                if (existingSellerResults) {
                    existingSellerResults.remove();
                }
                loadProducts();
                document.getElementById('searchSuggestions').classList.add('hidden');
            }
        }, 800)); // Increased delay to avoid too many API calls
        
        // Add Enter key listener for immediate search
        mainSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = e.target.value.trim();
                if (query.length >= 2) {
                    performMainSearch();
                }
            }
        });
    }
});

// Main search function for both products and sellers
function performMainSearch() {
    const searchQuery = document.getElementById('mainSearchInput').value.trim();
    
    if (!searchQuery) {
        showToast('يرجى إدخال كلمة البحث', 'warning');
        return;
    }
    
    console.log('performMainSearch called with:', searchQuery);
    
    // Reset to first page
    currentPage = 1;
    
    // Show search is happening
    showToast(`جاري البحث عن "${searchQuery}"...`, 'info');
    
    // Perform search for both products and sellers
    searchProductsAndSellers(searchQuery);
}

async function searchProductsAndSellers(query) {
    try {
        console.log('Searching for:', query);
        
        // Show loading state
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
        
        // Clear any existing seller results
        const existingSellerResults = document.getElementById('sellerResults');
        if (existingSellerResults) {
            existingSellerResults.remove();
        }
        
        // Search for products
        const productParams = new URLSearchParams({
            search: query,
            page: currentPage,
            limit: 12
        });
        
        console.log('Searching products with:', productParams.toString());
        const productResponse = await apiCall(`/api/products?${productParams.toString()}`);
        console.log('Product response:', productResponse);
        
        // Search for sellers
        const sellerParams = new URLSearchParams({
            search: query,
            page: 1,
            limit: 6
        });
        
        console.log('Searching sellers with:', sellerParams.toString());
        const sellerResponse = await apiCall(`/api/users/search?${sellerParams.toString()}`);
        console.log('Seller response:', sellerResponse);
        
        // Update pagination info
        totalProducts = productResponse.pagination?.total || productResponse.products?.length || 0;
        totalPages = Math.ceil(totalProducts / 12);
        
        // Hide loading state
        document.getElementById('loadingState').classList.add('hidden');
        
        // Display seller results first if any
        if (sellerResponse.users && sellerResponse.users.length > 0) {
            showSellerResults(sellerResponse.users);
        }
        
        // Display product results
        if (productResponse.products && productResponse.products.length > 0) {
            renderProducts(productResponse.products);
            
            if (sellerResponse.users && sellerResponse.users.length > 0) {
                showToast(`تم العثور على ${sellerResponse.users.length} بائع و ${totalProducts} منتج`, 'success');
            } else {
                showToast(`تم العثور على ${totalProducts} منتج`, 'success');
            }
        } else if (sellerResponse.users && sellerResponse.users.length > 0) {
            // Show only seller results
            document.getElementById('productsGrid').innerHTML = '';
            document.getElementById('emptyState').classList.add('hidden');
            showToast(`تم العثور على ${sellerResponse.users.length} بائع`, 'success');
        } else {
            // No results found
            document.getElementById('productsGrid').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
            showToast('لم يتم العثور على نتائج', 'info');
        }
        
    } catch (error) {
        console.error('Search error:', error);
        document.getElementById('loadingState').classList.add('hidden');
        showToast('حدث خطأ في البحث: ' + error.message, 'error');
    }
}

function showSellerResults(sellers) {
    // Remove any existing seller results
    const existingSellerResults = document.getElementById('sellerResults');
    if (existingSellerResults) {
        existingSellerResults.remove();
    }
    
    // Create seller results section
    const sellerResultsHTML = `
        <div id="sellerResults" class="col-span-full mb-8">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-2xl p-6 border border-purple-200 dark:border-purple-700 mb-6">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    <i class="fas fa-users ml-2 text-purple-500"></i>البائعين المطابقين للبحث
                </h3>
                <p class="text-gray-600 dark:text-gray-400">تم العثور على ${sellers.length} بائع يطابق بحثك</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${sellers.map(seller => `
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-600 p-6 hover:shadow-xl transition-all duration-300">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="h-12 w-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center overflow-hidden">
                                <img src="/api/profile/image/${seller.id}/profile" 
                                     alt="${seller.name}" 
                                     class="w-full h-full object-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <i class="fas fa-user text-white" style="display: none;"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">${seller.name}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${seller.city || 'غير محدد'}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <button onclick="contactSeller(${seller.id})" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all duration-300">
                                <i class="fas fa-comments ml-1"></i>رسالة
                            </button>
                            <button onclick="viewSellerProfile(${seller.id})" class="bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-slate-600 transition-all duration-300">
                                <i class="fas fa-eye ml-1"></i>عرض
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Insert seller results before products grid
    const productsGrid = document.getElementById('productsGrid');
    productsGrid.insertAdjacentHTML('beforebegin', sellerResultsHTML);
}

// Search Suggestions Function
function showSearchSuggestions(query) {
    const suggestionsContainer = document.getElementById('searchSuggestions');
    
    if (query.length < 2) {
        suggestionsContainer.classList.add('hidden');
        return;
    }
    
    // Mock suggestions - replace with actual API call
    const suggestions = [
        { type: 'product', text: 'هاتف آيفون', category: 'إلكترونيات' },
        { type: 'product', text: 'سيارة تويوتا', category: 'سيارات' },
        { type: 'seller', text: 'متجر التقنيات', category: 'بائع' },
        { type: 'seller', text: 'معرض السيارات', category: 'بائع' },
        { type: 'category', text: 'إلكترونيات', count: '150 منتج' }
    ];
    
    const filteredSuggestions = suggestions.filter(item => 
        item.text.toLowerCase().includes(query.toLowerCase())
    );
    
    if (filteredSuggestions.length > 0) {
        suggestionsContainer.innerHTML = filteredSuggestions.map(item => `
            <div class="p-4 hover:bg-gray-50 dark:hover:bg-slate-700 cursor-pointer border-b border-gray-100 dark:border-slate-600 last:border-b-0" onclick="selectSuggestion('${item.text}')">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-${item.type === 'product' ? 'box' : item.type === 'seller' ? 'store' : 'th-large'} text-white text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900 dark:text-white">${item.text}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${item.category || item.location || item.count}</p>
                    </div>
                </div>
            </div>
        `).join('');
        suggestionsContainer.classList.remove('hidden');
    } else {
        suggestionsContainer.classList.add('hidden');
    }
}

function selectSuggestion(text) {
    document.getElementById('mainSearchInput').value = text;
    document.getElementById('searchSuggestions').classList.add('hidden');
    performMainSearch();
}

// Dynamic Messages and Notifications Functions
async function loadMessagesCount() {
    try {
        console.log('Loading messages count from home page...');
        const response = await apiCall('/web/conversations');
        const count = response.unreadCount || 0;
        console.log('Messages count received:', count);
        lastMessageCount = count; // Set initial count
        updateMessagesBadge(count);
    } catch (error) {
        console.error('Error loading messages count:', error);
        updateMessagesBadge(0);
    }
}

async function loadNotificationsCount() {
    try {
        const response = await apiCall('/web/notifications/unread-count');
        const count = response.count || 0;
        updateNotificationsBadge(count);
    } catch (error) {
        console.error('Error loading notifications count:', error);
        updateNotificationsBadge(0);
    }
}

function updateMessagesBadge(count) {
    const badge = document.getElementById('messagesCount');
    if (badge) {
        console.log('Updating messages badge with count:', count);
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
            console.log('Messages badge shown with count:', count);
        } else {
            badge.classList.add('hidden');
            console.log('Messages badge hidden');
        }
    } else {
        console.error('Messages badge element not found');
    }
}

function updateNotificationsBadge(count) {
    const badge = document.getElementById('notificationsCount');
    if (badge) {
        console.log('Updating notifications badge with count:', count);
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
            console.log('Notifications badge shown with count:', count);
        } else {
            badge.classList.add('hidden');
            console.log('Notifications badge hidden');
        }
    } else {
        console.error('Notifications badge element not found');
    }
}

function openMessages() {
    window.location.href = '/messages';
}

function openNotifications() {
    window.location.href = '/notifications';
}

// Function to go to My Products page with authentication check
async function goToMyProducts() {
    try {
        // Check if user is authenticated by making a simple API call
        await apiCall('/web/conversations');
        
        // If we get here, user is authenticated, redirect to My Products page
        window.location.href = '/products/my';
    } catch (error) {
        console.error('Authentication check failed:', error);
        showToast('يجب تسجيل الدخول أولاً', 'warning');
        setTimeout(() => {
            window.location.href = '/login';
        }, 2000);
    }
}

// Real-time updates using polling (you can replace with WebSocket later)
function startRealTimeUpdates() {
    // Load initial counts
    loadMessagesCount();
    loadNotificationsCount();
    
    // Update counts every 30 seconds
    setInterval(() => {
        loadMessagesCount();
        loadNotificationsCount();
    }, 30000);
    
    // Check for new messages every 10 seconds for toast notifications
    setInterval(() => {
        checkForNewMessages();
    }, 10000);
}

// Check for new messages and show toast notifications
let lastMessageCount = 0;
async function checkForNewMessages() {
    try {
        console.log('Checking for new messages (home page)');
        const response = await apiCall('/web/conversations');
        const currentCount = response.unreadCount || 0;
        console.log('Current message count:', currentCount, 'Last count:', lastMessageCount);
        
        // If there are new messages (count increased)
        if (currentCount > lastMessageCount && lastMessageCount > 0) {
            const newMessages = currentCount - lastMessageCount;
            console.log('New messages detected:', newMessages);
            showToast(`لديك ${newMessages} رسالة جديدة`, 'info');
            
            // Show browser notification if page is not focused
            if (document.hidden || !document.hasFocus()) {
                showBrowserNotification({
                    title: 'رسالة جديدة',
                    message: `لديك ${newMessages} رسالة جديدة`,
                    icon: '/favicon.ico'
                });
            }
        }
        
        lastMessageCount = currentCount;
        updateMessagesBadge(currentCount);
    } catch (error) {
        console.error('Error checking for new messages:', error);
        if (error.message === 'Authentication required') {
            console.log('User not authenticated, stopping real-time updates');
        }
    }
}

// Browser notification function
function showBrowserNotification(notification) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(notification.title, {
            body: notification.message,
            icon: notification.icon || '/favicon.ico',
            badge: '/favicon.ico'
        });
    }
}

// Request notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}


function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}