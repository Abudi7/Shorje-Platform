{% extends 'base.html.twig' %}

{% block title %}الرئيسية - شورجي{% endblock %}

{% block body %}
<style>
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    
    .category-btn {
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .category-btn:hover {
        transform: translateY(-2px);
    }
    
    .category-btn:active {
        transform: scale(0.95);
    }
    
    /* Smooth scrolling for category slider */
    #categorySlider {
        scroll-behavior: smooth;
    }
</style>

<div class="min-h-screen bg-gray-50 dark:bg-slate-900">
    <!-- Navigation -->
    <!-- Ultra Professional Header -->
    <nav class="bg-white/95 dark:bg-slate-900/95 backdrop-blur-2xl shadow-2xl border-b border-white/30 dark:border-slate-700/30 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-24">
                <!-- Logo Section - Left -->
                <div class="flex items-center">
                    <div class="flex items-center space-x-4">
                        <!-- Professional Shopping Logo -->
                        <div class="relative">
                            <div class="h-16 w-16 bg-gradient-to-br from-emerald-500 via-green-600 to-teal-600 dark:from-emerald-400 dark:via-green-500 dark:to-teal-500 rounded-3xl flex items-center justify-center shadow-2xl transform hover:scale-110 transition-all duration-300">
                                <i class="fas fa-shopping-cart text-white text-2xl"></i>
                                <div class="absolute -top-1 -right-1 w-4 h-4 bg-orange-500 rounded-full border-2 border-white dark:border-slate-900 flex items-center justify-center">
                                    <span class="text-xs font-bold text-white">!</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Brand Text -->
                        <div class="flex flex-col">
                            <h1 class="text-4xl font-black bg-gradient-to-r from-emerald-500 via-green-600 to-teal-600 dark:from-emerald-400 dark:via-green-500 dark:to-teal-500 bg-clip-text text-transparent leading-tight">
                                شورجي
                            </h1>
                            <p class="text-sm font-semibold text-gray-600 dark:text-gray-300 tracking-wide">
                                منصة التسوق الذكية المتطورة
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Center Navigation - Hidden on mobile -->
                <div class="hidden lg:flex items-center space-x-8">
                    <a href="/home" class="group flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-cyan-600 dark:hover:text-cyan-400 font-semibold transition-all duration-300 transform hover:scale-105">
                        <div class="p-2 rounded-xl bg-gray-100 dark:bg-slate-800 group-hover:bg-cyan-100 dark:group-hover:bg-cyan-900/20 transition-colors duration-300">
                            <i class="fas fa-home text-lg"></i>
                        </div>
                        <span>الرئيسية</span>
                    </a>
                    <a href="/users" class="group flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-cyan-600 dark:hover:text-cyan-400 font-semibold transition-all duration-300 transform hover:scale-105">
                        <div class="p-2 rounded-xl bg-gray-100 dark:bg-slate-800 group-hover:bg-cyan-100 dark:group-hover:bg-cyan-900/20 transition-colors duration-300">
                            <i class="fas fa-users text-lg"></i>
                        </div>
                        <span>المستخدمين</span>
                    </a>
                    <a href="/messages" class="group flex items-center space-x-2 text-gray-700 dark:text-gray-300 hover:text-cyan-600 dark:hover:text-cyan-400 font-semibold transition-all duration-300 transform hover:scale-105">
                        <div class="p-2 rounded-xl bg-gray-100 dark:bg-slate-800 group-hover:bg-cyan-100 dark:group-hover:bg-cyan-900/20 transition-colors duration-300">
                            <i class="fas fa-comment text-lg"></i>
                        </div>
                        <span>الرسائل</span>
                    </a>
                </div>

                <!-- User Section - Right -->
                <div class="flex items-center space-x-4">
                    {% if user %}
                    <!-- Enhanced User Avatar with Dropdown -->
                    <div class="relative" id="userDropdown">
                        <button onclick="toggleUserDropdown()" class="group flex items-center space-x-4 bg-gradient-to-r from-white/20 to-white/10 dark:from-slate-800/20 dark:to-slate-700/10 hover:from-white/30 hover:to-white/20 dark:hover:from-slate-800/30 dark:hover:to-slate-700/20 px-6 py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-xl backdrop-blur-sm border border-white/30 dark:border-slate-700/30">
                            <!-- Enhanced User Avatar -->
                            <div class="relative">
                                <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 flex items-center justify-center overflow-hidden shadow-2xl">
                                    {% if user.profilePicture %}
                                    <img src="/api/profile/image/{{ user.id }}/profile" 
                                         alt="{{ user.getFullName() }}" 
                                         class="w-full h-full object-cover"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    {% endif %}
                                    <div class="flex items-center justify-center text-white text-lg font-bold" 
                                         style="display: {{ user.profilePicture ? 'none' : 'flex' }};">
                                        {{ user.firstName ? user.firstName|slice(0,1)|upper : 'U' }}
                                    </div>
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-slate-900"></div>
                            </div>
                            
                            <!-- Enhanced User Info -->
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-900 dark:text-white">{{ user.getFullName() }}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">{{ user.email }}</div>
                            </div>
                            
                            <!-- Enhanced Dropdown Arrow -->
                            <i class="fas fa-chevron-down text-gray-500 dark:text-gray-400 text-lg transition-transform duration-300 group-hover:rotate-180" id="dropdownArrow"></i>
                        </button>

                        <!-- Enhanced Dropdown Menu -->
                        <div id="userDropdownMenu" class="absolute left-0 mt-3 w-80 bg-white/95 dark:bg-slate-800/95 rounded-3xl shadow-2xl border border-gray-200/50 dark:border-slate-700/50 backdrop-blur-2xl opacity-0 invisible transform scale-95 transition-all duration-300 origin-top-right">
                            <div class="p-6">
                                <!-- Enhanced User Info Header -->
                                <div class="flex items-center space-x-4 pb-6 border-b border-gray-200/50 dark:border-slate-700/50">
                                    <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 flex items-center justify-center overflow-hidden shadow-xl">
                                        {% if user.profilePicture %}
                                        <img src="/api/profile/image/{{ user.id }}/profile" 
                                             alt="{{ user.getFullName() }}" 
                                             class="w-full h-full object-cover"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        {% endif %}
                                        <div class="flex items-center justify-center text-white font-bold text-xl" 
                                             style="display: {{ user.profilePicture ? 'none' : 'flex' }};">
                                            {{ user.firstName ? user.firstName|slice(0,1)|upper : 'U' }}
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-xl font-bold text-gray-900 dark:text-white">{{ user.getFullName() }}</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">{{ user.email }}</div>
                                        <div class="text-xs text-green-600 dark:text-green-400 font-semibold mt-1">
                                            <i class="fas fa-circle text-xs ml-1"></i>متصل الآن
                                        </div>
                                    </div>
                                </div>

                                <!-- Enhanced Menu Items -->
                                <div class="py-4 space-y-2">
                                    <a href="/profile" class="group flex items-center space-x-4 px-4 py-4 text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-cyan-50 hover:to-blue-50 dark:hover:from-cyan-900/20 dark:hover:to-blue-900/20 rounded-2xl transition-all duration-300 transform hover:scale-105">
                                        <div class="p-3 rounded-xl bg-cyan-100 dark:bg-cyan-900/30 group-hover:bg-cyan-200 dark:group-hover:bg-cyan-800/50 transition-colors duration-300">
                                            <i class="fas fa-user text-cyan-600 dark:text-cyan-400"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold">الملف الشخصي</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">عرض وتعديل ملفك الشخصي</div>
                                        </div>
                                    </a>
                                    
                                    <a href="/edit-profile" class="group flex items-center space-x-4 px-4 py-4 text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 dark:hover:from-blue-900/20 dark:hover:to-indigo-900/20 rounded-2xl transition-all duration-300 transform hover:scale-105">
                                        <div class="p-3 rounded-xl bg-blue-100 dark:bg-blue-900/30 group-hover:bg-blue-200 dark:group-hover:bg-blue-800/50 transition-colors duration-300">
                                            <i class="fas fa-edit text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold">تعديل الملف</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">تحديث معلوماتك الشخصية</div>
                                        </div>
                                    </a>
                                    
                                    <a href="/messages" class="group flex items-center space-x-4 px-4 py-4 text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 dark:hover:from-green-900/20 dark:hover:to-emerald-900/20 rounded-2xl transition-all duration-300 transform hover:scale-105">
                                        <div class="p-3 rounded-xl bg-green-100 dark:bg-green-900/30 group-hover:bg-green-200 dark:group-hover:bg-green-800/50 transition-colors duration-300">
                                            <i class="fas fa-comment text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold">الرسائل</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">محادثاتك مع المستخدمين</div>
                                        </div>
                                    </a>
                                    
                                    <a href="/users" class="group flex items-center space-x-4 px-4 py-4 text-gray-700 dark:text-gray-300 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 dark:hover:from-purple-900/20 dark:hover:to-pink-900/20 rounded-2xl transition-all duration-300 transform hover:scale-105">
                                        <div class="p-3 rounded-xl bg-purple-100 dark:bg-purple-900/30 group-hover:bg-purple-200 dark:group-hover:bg-purple-800/50 transition-colors duration-300">
                                            <i class="fas fa-users text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold">المستخدمين</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">تصفح جميع المستخدمين</div>
                                        </div>
                                    </a>
                                </div>

                                <!-- Enhanced Divider -->
                                <div class="border-t border-gray-200/50 dark:border-slate-700/50 my-4"></div>

                                <!-- Enhanced Logout -->
                                <button onclick="logout()" class="group w-full flex items-center space-x-4 px-4 py-4 text-red-600 dark:text-red-400 hover:bg-gradient-to-r hover:from-red-50 hover:to-pink-50 dark:hover:from-red-900/20 dark:hover:to-pink-900/20 rounded-2xl transition-all duration-300 transform hover:scale-105">
                                    <div class="p-3 rounded-xl bg-red-100 dark:bg-red-900/30 group-hover:bg-red-200 dark:group-hover:bg-red-800/50 transition-colors duration-300">
                                        <i class="fas fa-sign-out-alt text-red-600 dark:text-red-400"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold">تسجيل الخروج</div>
                                        <div class="text-xs text-red-500 dark:text-red-400">إنهاء الجلسة الحالية</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Enhanced Guest User Buttons -->
                    <div class="flex items-center space-x-4">
                        <a href="/login" class="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white px-8 py-4 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-2xl flex items-center space-x-3">
                            <i class="fas fa-sign-in-alt text-lg"></i>
                            <span>تسجيل الدخول</span>
                        </a>
                        <a href="/register" class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-8 py-4 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-2xl flex items-center space-x-3">
                            <i class="fas fa-user-plus text-lg"></i>
                            <span>إنشاء حساب</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Full-Screen Hero Slider Section -->
    <div class="relative w-full h-screen overflow-hidden">
        <!-- Full-Screen Slider Container -->
        <div class="relative w-full h-full">
            <div id="heroSlider" class="relative w-full h-full">
                    {% if sliderImages|length > 0 %}
                        {% for sliderImage in sliderImages %}
                        <div class="slider-slide {{ loop.first ? 'active' : '' }} absolute inset-0 transition-all duration-1000 ease-in-out {{ loop.first ? '' : 'opacity-0' }}">
                            {% if sliderImage.image %}
                            <img src="/admin/slider/{{ sliderImage.id }}/image" 
                                 alt="{{ sliderImage.title }}" 
                                 class="absolute inset-0 w-full h-full object-cover">
                            {% else %}
                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/90 via-green-600/90 to-teal-600/90"></div>
                            {% endif %}
                            <div class="absolute inset-0 bg-black/50"></div>
                            <div class="relative z-10 flex items-center justify-center h-full">
                                <div class="text-center text-white px-8 max-w-4xl mx-auto">
                                    <h2 class="text-5xl md:text-7xl lg:text-8xl font-black mb-8 leading-tight">
                                        {{ sliderImage.title }}
                                    </h2>
                                    {% if sliderImage.description %}
                                    <p class="text-2xl md:text-3xl lg:text-4xl mb-12 font-semibold leading-relaxed">
                                        {{ sliderImage.description }}
                                    </p>
                                    {% endif %}
                                    <div class="flex flex-col sm:flex-row gap-6 justify-center">
                                        {% if sliderImage.buttonText and sliderImage.buttonUrl %}
                                        <a href="{{ sliderImage.buttonUrl }}" class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-12 py-6 rounded-3xl font-bold text-xl transition-all duration-300 transform hover:scale-110 shadow-2xl">
                                            <i class="fas fa-shopping-cart ml-3"></i>{{ sliderImage.buttonText }}
                                        </a>
                                        {% endif %}
                                        {% if sliderImage.buttonText2 and sliderImage.buttonUrl2 %}
                                        <a href="{{ sliderImage.buttonUrl2 }}" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-12 py-6 rounded-3xl font-bold text-xl transition-all duration-300 transform hover:scale-110 border-2 border-white/30">
                                            <i class="fas fa-arrow-left ml-3"></i>{{ sliderImage.buttonText2 }}
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Default slides when no slider images are configured -->
                        <div class="slider-slide active absolute inset-0 transition-all duration-1000 ease-in-out">
                            <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/90 via-green-600/90 to-teal-600/90"></div>
                            <div class="absolute inset-0 bg-black/50"></div>
                            <div class="relative z-10 flex items-center justify-center h-full">
                                <div class="text-center text-white px-8 max-w-4xl mx-auto">
                                    <h2 class="text-5xl md:text-7xl lg:text-8xl font-black mb-8 leading-tight">
                                        مرحباً بك في <span class="text-yellow-300">شورجي</span>
                                    </h2>
                                    <p class="text-2xl md:text-3xl lg:text-4xl mb-12 font-semibold leading-relaxed">
                                        منصة التسوق الذكية المتطورة
                                    </p>
                                    <div class="flex flex-col sm:flex-row gap-6 justify-center">
                                        <a href="/register" class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-12 py-6 rounded-3xl font-bold text-xl transition-all duration-300 transform hover:scale-110 shadow-2xl">
                                            <i class="fas fa-shopping-cart ml-3"></i>ابدأ التسوق الآن
                                        </a>
                                        <a href="/users" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-12 py-6 rounded-3xl font-bold text-xl transition-all duration-300 transform hover:scale-110 border-2 border-white/30">
                                            <i class="fas fa-users ml-3"></i>تصفح المستخدمين
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Professional Slider Controls -->
                {% if sliderImages|length > 1 %}
                <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-4">
                    {% for sliderImage in sliderImages %}
                    <button onclick="changeSlide({{ loop.index0 }})" class="slider-dot w-5 h-5 rounded-full {{ loop.first ? 'bg-white/90 active' : 'bg-white/50' }} hover:bg-white transition-all duration-300 shadow-lg"></button>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Professional Navigation Arrows -->
                <button onclick="previousSlide()" class="absolute left-8 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 backdrop-blur-md text-white p-6 rounded-3xl transition-all duration-300 transform hover:scale-110 shadow-2xl border border-white/30">
                    <i class="fas fa-chevron-right text-2xl"></i>
                </button>
                <button onclick="nextSlide()" class="absolute right-8 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 backdrop-blur-md text-white p-6 rounded-3xl transition-all duration-300 transform hover:scale-110 shadow-2xl border border-white/30">
                    <i class="fas fa-chevron-left text-2xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Professional Category Section -->
    <div class="bg-gradient-to-br from-slate-50 via-white to-emerald-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-black text-slate-800 dark:text-white mb-4">
                    <i class="fas fa-shopping-bag ml-4 text-emerald-500"></i>تصفح حسب الفئة
                </h2>
                <p class="text-xl text-gray-600 dark:text-gray-400">اكتشف المنتجات والخدمات المتنوعة</p>
            </div>
            
            <!-- Category Slider -->
            <div class="relative">
                <div class="flex space-x-4 overflow-x-auto scrollbar-hide pb-4" id="categorySlider">
                        <!-- All Categories Button -->
                        <button onclick="filterByCategory('all')" 
                                class="category-btn flex-shrink-0 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-10 py-5 rounded-3xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-2xl active:scale-95" 
                                data-category="all">
                            <i class="fas fa-th-large ml-3 text-xl"></i>
                            <span>الكل</span>
                        </button>
                    
                        <!-- Car Category -->
                        <button onclick="filterByCategory('car')" 
                                class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 px-10 py-5 rounded-3xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-xl border-2 border-gray-200 dark:border-slate-600 hover:border-emerald-300 dark:hover:border-emerald-600 active:scale-95" 
                                data-category="car">
                            <i class="fas fa-car ml-3 text-xl"></i>
                            <span>سيارات</span>
                        </button>
                    
                    <!-- Home Rental Category -->
                    <button onclick="filterByCategory('home_rental')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="home_rental">
                        <i class="fas fa-home ml-3 text-lg"></i>
                        <span>إيجار منازل</span>
                    </button>
                    
                    <!-- Apartment Rental Category -->
                    <button onclick="filterByCategory('apartment_rental')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="apartment_rental">
                        <i class="fas fa-building ml-3 text-lg"></i>
                        <span>إيجار شقق</span>
                    </button>
                    
                    <!-- Job Category -->
                    <button onclick="filterByCategory('job')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="job">
                        <i class="fas fa-briefcase ml-3 text-lg"></i>
                        <span>وظائف</span>
                    </button>
                    
                    <!-- Laptop Category -->
                    <button onclick="filterByCategory('laptop')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="laptop">
                        <i class="fas fa-laptop ml-3 text-lg"></i>
                        <span>لابتوب</span>
                    </button>
                    
                    <!-- Electronics Category -->
                    <button onclick="filterByCategory('electronics')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="electronics">
                        <i class="fas fa-microchip ml-3 text-lg"></i>
                        <span>إلكترونيات</span>
                    </button>
                    
                    <!-- Fashion Category -->
                    <button onclick="filterByCategory('fashion')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="fashion">
                        <i class="fas fa-tshirt ml-3 text-lg"></i>
                        <span>أزياء</span>
                    </button>
                    
                    <!-- Furniture Category -->
                    <button onclick="filterByCategory('furniture')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="furniture">
                        <i class="fas fa-couch ml-3 text-lg"></i>
                        <span>أثاث</span>
                    </button>
                    
                    <!-- Books Category -->
                    <button onclick="filterByCategory('books')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="books">
                        <i class="fas fa-book ml-3 text-lg"></i>
                        <span>كتب</span>
                    </button>
                    
                    <!-- Sports Category -->
                    <button onclick="filterByCategory('sports')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="sports">
                        <i class="fas fa-futbol ml-3 text-lg"></i>
                        <span>رياضة</span>
                    </button>
                    
                    <!-- Other Category -->
                    <button onclick="filterByCategory('other')" 
                            class="category-btn flex-shrink-0 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg border border-gray-200 dark:border-slate-600 active:scale-95" 
                            data-category="other">
                        <i class="fas fa-ellipsis-h ml-3 text-lg"></i>
                        <span>أخرى</span>
                    </button>
                </div>
                
                <!-- Scroll Indicators -->
                <div class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-white dark:from-slate-800 to-transparent w-8 h-full pointer-events-none"></div>
                <div class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-gradient-to-l from-white dark:from-slate-800 to-transparent w-8 h-full pointer-events-none"></div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Sidebar - Filters -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-white/20 dark:border-slate-700/20 p-6 sticky top-24">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-6">
                        <i class="fas fa-filter ml-2 text-cyan-500 dark:text-cyan-400"></i>تصفية المنتجات
                    </h3>
                    
                    <!-- Search -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">البحث</label>
                        <input type="text" id="searchInput" placeholder="ابحث عن منتج..." 
                               class="w-full px-4 py-3 bg-gray-100 dark:bg-slate-700 border-0 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    </div>

                    <!-- Category Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">الفئة</label>
                        <select id="categoryFilter" class="w-full px-4 py-3 bg-gray-100 dark:bg-slate-700 border-0 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="">جميع الفئات</option>
                            <option value="car">سيارات</option>
                            <option value="home_rental">إيجار منازل</option>
                            <option value="apartment_rental">إيجار شقق</option>
                            <option value="job">وظائف</option>
                            <option value="laptop">لابتوب</option>
                            <option value="electronics">إلكترونيات</option>
                            <option value="fashion">أزياء</option>
                            <option value="furniture">أثاث</option>
                            <option value="books">كتب</option>
                            <option value="sports">رياضة</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>

                    <!-- City Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">المدينة</label>
                        <select id="cityFilter" class="w-full px-4 py-3 bg-gray-100 dark:bg-slate-700 border-0 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="">جميع المدن</option>
                            <option value="بغداد">بغداد</option>
                            <option value="البصرة">البصرة</option>
                            <option value="الموصل">الموصل</option>
                            <option value="أربيل">أربيل</option>
                            <option value="السليمانية">السليمانية</option>
                            <option value="دهوك">دهوك</option>
                            <option value="كركوك">كركوك</option>
                            <option value="الرمادي">الرمادي</option>
                            <option value="الفلوجة">الفلوجة</option>
                            <option value="تكريت">تكريت</option>
                            <option value="بعقوبة">بعقوبة</option>
                            <option value="كربلاء">كربلاء</option>
                            <option value="النجف">النجف</option>
                            <option value="الحلة">الحلة</option>
                            <option value="الكوت">الكوت</option>
                            <option value="الديوانية">الديوانية</option>
                            <option value="السماوة">السماوة</option>
                            <option value="الناصرية">الناصرية</option>
                            <option value="العمارة">العمارة</option>
                        </select>
                    </div>

                    <!-- Price Range -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">نطاق السعر</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="minPrice" placeholder="الحد الأدنى" 
                                   class="px-3 py-2 bg-gray-100 dark:bg-slate-700 border-0 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <input type="number" id="maxPrice" placeholder="الحد الأقصى" 
                                   class="px-3 py-2 bg-gray-100 dark:bg-slate-700 border-0 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="space-y-3">
                        <button onclick="applyFilters()" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 shadow-lg">
                            <i class="fas fa-search ml-2"></i>تطبيق الفلاتر
                        </button>
                        <button onclick="clearFilters()" class="w-full bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 px-6 py-3 rounded-xl font-medium transition-all duration-300">
                            <i class="fas fa-times ml-2"></i>مسح الفلاتر
                        </button>
                    </div>
                </div>
                
                <!-- Seller Search Section -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-white/20 dark:border-slate-700/20 p-6 mt-6">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-6">
                        <i class="fas fa-users ml-2 text-purple-500 dark:text-purple-400"></i>البحث عن البائعين
                    </h3>
                    
                    <!-- Seller Search -->
                    <div class="mb-4">
                        <input type="text" id="sellerSearchInput" placeholder="ابحث عن بائع بالاسم أو البريد الإلكتروني..." 
                               class="w-full px-4 py-3 bg-gray-100 dark:bg-slate-700 border-0 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- Search Results -->
                    <div id="sellerSearchResults" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="lg:col-span-3">
                <!-- Post Product Button -->
                {% if user %}
                <div class="mb-6">
                    <button onclick="openPostProductModal()" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-2xl">
                        <i class="fas fa-plus ml-3 text-lg"></i>نشر منتج جديد للبيع
                    </button>
                </div>
                {% endif %}

                <!-- Seller Search Section -->
                <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 dark:border-slate-700/20 p-6 mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-4">
                        <i class="fas fa-search ml-2 text-purple-500 dark:text-purple-400"></i>البحث عن البائعين
                    </h2>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="homeSellerSearchInput" placeholder="ابحث عن بائع بالاسم أو البريد الإلكتروني..." 
                                   class="w-full px-4 py-3 bg-gray-100 dark:bg-slate-700 border-0 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <button onclick="clearHomeSearch()" class="bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 text-gray-700 dark:text-slate-300 px-6 py-3 rounded-xl font-medium transition-all duration-300">
                            <i class="fas fa-times ml-2"></i>مسح البحث
                        </button>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="homeSellerSearchResults" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
                        <!-- Search results will be populated here -->
                    </div>
                </div>

                <!-- Products Feed -->
                <div id="productsFeed" class="space-y-6">
                    {% for product in recentProducts %}
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-white/20 dark:border-slate-700/20 overflow-hidden">
                        <!-- Product Header -->
                        <div class="p-6 border-b border-gray-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="h-12 w-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center overflow-hidden">
                                        <img src="/api/profile/image/{{ product.seller.id }}/profile" 
                                             alt="{{ product.seller.getFullName() }}" 
                                             class="w-full h-full object-cover"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">{{ product.seller.getFullName() }}</h3>
                                        <p class="text-sm text-slate-600 dark:text-slate-400">{{ product.createdAt|date('d/m/Y H:i') }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="bg-cyan-100 dark:bg-cyan-900 text-cyan-800 dark:text-cyan-200 px-3 py-1 rounded-full text-sm font-medium">
                                        {{ product.getCategoryDisplayName() }}
                                    </span>
                                    <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-medium">
                                        {{ product.getStatusDisplayName() }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Product Content -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Product Images -->
                                <div class="md:col-span-2">
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                        {% if product.image1 %}
                                        <div class="aspect-square bg-gray-100 dark:bg-slate-700 rounded-xl overflow-hidden">
                                            <img src="/api/products/image/{{ product.id }}/1" 
                                                 alt="{{ product.title }}" 
                                                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300"
                                                 onclick="openImageModal('/api/products/image/{{ product.id }}/1')">
                                        </div>
                                        {% endif %}
                                        {% if product.image2 %}
                                        <div class="aspect-square bg-gray-100 dark:bg-slate-700 rounded-xl overflow-hidden">
                                            <img src="/api/products/image/{{ product.id }}/2" 
                                                 alt="{{ product.title }}" 
                                                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300"
                                                 onclick="openImageModal('/api/products/image/{{ product.id }}/2')">
                                        </div>
                                        {% endif %}
                                        {% if product.image3 %}
                                        <div class="aspect-square bg-gray-100 dark:bg-slate-700 rounded-xl overflow-hidden">
                                            <img src="/api/products/image/{{ product.id }}/3" 
                                                 alt="{{ product.title }}" 
                                                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300"
                                                 onclick="openImageModal('/api/products/image/{{ product.id }}/3')">
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Product Details -->
                                <div class="space-y-4">
                                    <div>
                                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">{{ product.title }}</h2>
                                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">{{ product.description }}</p>
                                    </div>

                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">السعر:</span>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{{ product.price }}</span>
                                                <span class="text-sm text-slate-600 dark:text-slate-400">{{ product.getCurrencyDisplayName() }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">المدينة:</span>
                                            <span class="text-slate-800 dark:text-white font-medium">{{ product.city }}</span>
                                        </div>
                                        
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">الموقع:</span>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-slate-800 dark:text-white font-medium">{{ product.location }}</span>
                                                <button onclick="openGoogleMaps('{{ product.location }}, {{ product.city }}, Iraq')" 
                                                        class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                                                        title="عرض على خرائط جوجل">
                                                    <i class="fas fa-map-marker-alt text-sm"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {% if product.color %}
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">اللون:</span>
                                            <span class="text-slate-800 dark:text-white font-medium">{{ product.color }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if product.condition %}
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">الحالة:</span>
                                            <span class="text-slate-800 dark:text-white font-medium">{{ product.condition }}</span>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex space-x-3 pt-4">
                                        {% if user and user.id == product.seller.id %}
                                            <!-- Edit button for product owner -->
                                            <button onclick="editProduct({{ product.id }})" class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 shadow-lg">
                                                <i class="fas fa-edit ml-2"></i>تعديل المنتج
                                            </button>
                                            <button onclick="deleteProduct({{ product.id }})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <!-- Contact button for other users -->
                                            <button onclick="contactSeller({{ product.seller.id }})" class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 shadow-lg">
                                                <i class="fas fa-comment ml-2"></i>تواصل مع البائع
                                            </button>
                                            {% if user and user.id != product.seller.id %}
                                            <button onclick="toggleFollow({{ product.seller.id }})" class="bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 px-4 py-3 rounded-xl font-medium transition-all duration-300">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Load More Button -->
                <div class="text-center mt-8">
                    <button onclick="loadMoreProducts()" class="bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 px-8 py-3 rounded-xl font-medium transition-all duration-300 border border-gray-200 dark:border-slate-700">
                        <i class="fas fa-plus ml-2"></i>تحميل المزيد
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Post Product Modal -->
<div id="postProductModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/20 w-full max-w-4xl max-h-[95vh] overflow-y-auto mx-4">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-gray-200/50 dark:border-slate-700/50 rounded-t-3xl px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 bg-gradient-to-r from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-plus text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-white">نشر منتج جديد</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400">املأ التفاصيل أدناه لنشر منتجك</p>
                    </div>
                </div>
                <button onclick="closePostProductModal()" class="h-10 w-10 bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-xl flex items-center justify-center transition-all duration-200">
                    <i class="fas fa-times text-gray-600 dark:text-slate-400"></i>
                </button>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-8">
            <form id="postProductForm" class="space-y-8">
            <!-- Product Title & Price Section -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-blue-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-tag ml-2 text-blue-500"></i>عنوان المنتج *
                        </label>
                        <input type="text" id="productTitle" required placeholder="أدخل عنوان المنتج..."
                               class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 shadow-sm">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-dollar-sign ml-2 text-green-500"></i>السعر *
                        </label>
                        <div class="flex space-x-3">
                            <input type="number" id="productPrice" required min="0" step="0.01" placeholder="0.00"
                                   class="flex-1 px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <select id="productCurrency" class="px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 shadow-sm">
                                <option value="IQD">دينار عراقي</option>
                                <option value="USD">دولار أمريكي</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 dark:text-slate-400">أدخل السعر بالعملة المختارة</p>
                            <button type="button" onclick="convertCurrency()" class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-3 py-1 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors flex items-center">
                                <i class="fas fa-exchange-alt ml-1"></i>تحويل العملة
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description Section -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-purple-100 dark:border-slate-600">
                <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">
                    <i class="fas fa-align-right ml-2 text-purple-500"></i>وصف المنتج *
                </label>
                <textarea id="productDescription" required rows="4" placeholder="اكتب وصفاً مفصلاً عن منتجك..."
                          class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 shadow-sm resize-none"></textarea>
            </div>

            <!-- Category & Location Section -->
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-emerald-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-th-large ml-2 text-emerald-500"></i>الفئة *
                        </label>
                        <select id="productCategory" required
                                class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <option value="">اختر الفئة</option>
                            <option value="car">🚗 سيارات</option>
                            <option value="home_rental">🏠 إيجار منازل</option>
                            <option value="apartment_rental">🏢 إيجار شقق</option>
                            <option value="job">💼 وظائف</option>
                            <option value="laptop">💻 لابتوب</option>
                            <option value="electronics">📱 إلكترونيات</option>
                            <option value="fashion">👕 أزياء</option>
                            <option value="furniture">🪑 أثاث</option>
                            <option value="books">📚 كتب</option>
                            <option value="sports">⚽ رياضة</option>
                            <option value="other">📦 أخرى</option>
                        </select>
                    </div>
                
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-map-marker-alt ml-2 text-teal-500"></i>المدينة *
                        </label>
                        <select id="productCity" required
                                class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200 shadow-sm">
                        <option value="">اختر المدينة</option>
                        <option value="بغداد">بغداد</option>
                        <option value="البصرة">البصرة</option>
                        <option value="الموصل">الموصل</option>
                        <option value="أربيل">أربيل</option>
                        <option value="السليمانية">السليمانية</option>
                        <option value="دهوك">دهوك</option>
                        <option value="كركوك">كركوك</option>
                        <option value="الرمادي">الرمادي</option>
                        <option value="الفلوجة">الفلوجة</option>
                        <option value="تكريت">تكريت</option>
                        <option value="بعقوبة">بعقوبة</option>
                        <option value="كربلاء">كربلاء</option>
                        <option value="النجف">النجف</option>
                        <option value="الحلة">الحلة</option>
                        <option value="الكوت">الكوت</option>
                        <option value="الديوانية">الديوانية</option>
                        <option value="السماوة">السماوة</option>
                        <option value="الناصرية">الناصرية</option>
                        <option value="العمارة">العمارة</option>
                        <option value="الأنبار">الأنبار</option>
                        <option value="ديالى">ديالى</option>
                        <option value="واسط">واسط</option>
                        <option value="ميسان">ميسان</option>
                        <option value="ذي قار">ذي قار</option>
                        <option value="المثنى">المثنى</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Location & Details Section -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-orange-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-map-pin ml-2 text-orange-500"></i>العنوان التفصيلي *
                        </label>
                        <div class="relative">
                            <input type="text" id="productLocation" required placeholder="مثال: شارع الرشيد، حي الكرادة، بغداد"
                                   class="w-full px-4 py-4 pr-12 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <button type="button" onclick="getCurrentLocation()" 
                                    class="absolute left-3 top-1/2 transform -translate-y-1/2 text-orange-500 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300 transition-colors"
                                    title="الحصول على الموقع الحالي">
                                <i class="fas fa-map-marker-alt text-lg"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-500 dark:text-slate-400">أدخل العنوان التفصيلي ليظهر على خرائط جوجل</p>
                            <button type="button" onclick="getCurrentLocation()" 
                                    class="text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 px-3 py-1 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors flex items-center">
                                <i class="fas fa-crosshairs ml-1"></i>استخدام الموقع الحالي
                            </button>
                        </div>
                    </div>
                
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-palette ml-2 text-red-500"></i>اللون
                        </label>
                        <select id="productColor" class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <option value="">اختر اللون</option>
                            <option value="أبيض">⚪ أبيض</option>
                            <option value="أسود">⚫ أسود</option>
                            <option value="أحمر">🔴 أحمر</option>
                            <option value="أزرق">🔵 أزرق</option>
                            <option value="أخضر">🟢 أخضر</option>
                            <option value="أصفر">🟡 أصفر</option>
                            <option value="برتقالي">🟠 برتقالي</option>
                            <option value="بنفسجي">🟣 بنفسجي</option>
                            <option value="وردي">🩷 وردي</option>
                            <option value="بني">🟤 بني</option>
                            <option value="رمادي">🔘 رمادي</option>
                            <option value="فضي">⚪ فضي</option>
                            <option value="ذهبي">🟡 ذهبي</option>
                            <option value="نحاسي">🟤 نحاسي</option>
                            <option value="متعدد الألوان">🌈 متعدد الألوان</option>
                            <option value="أخرى">❓ أخرى</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Condition & Images Section -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-indigo-100 dark:border-slate-600">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-star ml-2 text-indigo-500"></i>حالة المنتج
                        </label>
                        <select id="productCondition" class="w-full px-4 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-xl text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 shadow-sm">
                            <option value="">اختر الحالة</option>
                            <option value="جديد">✨ جديد</option>
                            <option value="مستعمل - ممتاز">⭐ مستعمل - ممتاز</option>
                            <option value="مستعمل - جيد جداً">👍 مستعمل - جيد جداً</option>
                            <option value="مستعمل - جيد">👍 مستعمل - جيد</option>
                            <option value="مستعمل - مقبول">👌 مستعمل - مقبول</option>
                            <option value="يحتاج إصلاح">🔧 يحتاج إصلاح</option>
                            <option value="للقطع">🔨 للقطع</option>
                            <option value="مشروع">🚧 مشروع</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="flex items-center text-sm font-semibold text-slate-700 dark:text-slate-300">
                            <i class="fas fa-images ml-2 text-purple-500"></i>صور المنتج (اختياري)
                        </label>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="aspect-square bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 group" onclick="selectImage(1)">
                                <input type="file" id="image1" accept="image/*" style="display: none;" onchange="handleImagePreview(1)">
                                <div id="image1Preview" class="text-center">
                                    <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة 1</p>
                                </div>
                            </div>
                            <div class="aspect-square bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 group" onclick="selectImage(2)">
                                <input type="file" id="image2" accept="image/*" style="display: none;" onchange="handleImagePreview(2)">
                                <div id="image2Preview" class="text-center">
                                    <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة 2</p>
                                </div>
                            </div>
                            <div class="aspect-square bg-white dark:bg-slate-800 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 group" onclick="selectImage(3)">
                                <input type="file" id="image3" accept="image/*" style="display: none;" onchange="handleImagePreview(3)">
                                <div id="image3Preview" class="text-center">
                                    <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة 3</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="bg-gradient-to-r from-emerald-50 to-green-50 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border border-emerald-100 dark:border-slate-600">
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button type="submit" id="submitProductBtn" class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-plus ml-2 text-lg"></i>نشر المنتج
                    </button>
                    <button type="button" onclick="closePostProductModal()" class="px-8 py-4 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-700 dark:text-slate-300 rounded-xl font-semibold transition-all duration-300 border border-gray-200 dark:border-slate-600 flex items-center justify-center">
                        <i class="fas fa-times ml-2"></i>إلغاء
                    </button>
                </div>
            </div>
        </form>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="max-w-4xl max-h-[90vh] p-4">
        <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<script>
let currentPage = 1;
let isLoading = false;

// User Dropdown Toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdownMenu');
    const arrow = document.getElementById('dropdownArrow');
    
    if (dropdown.classList.contains('opacity-0')) {
        // Show dropdown
        dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
        dropdown.classList.add('opacity-100', 'visible', 'scale-100');
        arrow.classList.add('rotate-180');
    } else {
        // Hide dropdown
        dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
        dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
        arrow.classList.remove('rotate-180');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('userDropdown');
    const dropdownMenu = document.getElementById('userDropdownMenu');
    
    if (dropdown && !dropdown.contains(event.target)) {
        dropdownMenu.classList.add('opacity-0', 'invisible', 'scale-95');
        dropdownMenu.classList.remove('opacity-100', 'visible', 'scale-100');
        document.getElementById('dropdownArrow').classList.remove('rotate-180');
    }
});

// Logout function
async function logout() {
    try {
        showLoading();
        const response = await apiCall('/api/logout', { method: 'POST' });
        
        if (response.success) {
            localStorage.removeItem('jwt_token');
            showToast('تم تسجيل الخروج بنجاح', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        } else {
            showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
        }
    } catch (error) {
        console.error('Logout error:', error);
        showToast('حدث خطأ أثناء تسجيل الخروج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Post Product Modal Functions
function openPostProductModal() {
    document.getElementById('postProductModal').classList.remove('hidden');
}

function closePostProductModal() {
    document.getElementById('postProductModal').classList.add('hidden');
    document.getElementById('postProductForm').reset();
    clearImagePreviews();
}

function selectImage(imageNumber) {
    document.getElementById(`image${imageNumber}`).click();
}

function handleImagePreview(imageNumber) {
    const file = document.getElementById(`image${imageNumber}`).files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById(`image${imageNumber}Preview`);
            preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;
        };
        reader.readAsDataURL(file);
    }
}

function clearImagePreviews() {
    for (let i = 1; i <= 3; i++) {
        const preview = document.getElementById(`image${i}Preview`);
        preview.innerHTML = `
            <i class="fas fa-camera text-2xl text-purple-400 group-hover:text-purple-600 dark:group-hover:text-purple-300 mb-2 transition-colors"></i>
            <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">صورة ${i}</p>
        `;
    }
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Image Modal Functions
function openImageModal(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
}

// Post Product Form
document.getElementById('postProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    console.log('Form submission started');
    
    // Validate required fields
    const requiredFields = ['productTitle', 'productDescription', 'productPrice', 'productCategory', 'productCity', 'productLocation'];
    const missingFields = [];
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            missingFields.push(fieldId);
            field.classList.add('ring-2', 'ring-red-500');
        } else {
            field.classList.remove('ring-2', 'ring-red-500');
        }
    });
    
    if (missingFields.length > 0) {
        showToast('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    const formData = {
        title: document.getElementById('productTitle').value.trim(),
        description: document.getElementById('productDescription').value.trim(),
        price: document.getElementById('productPrice').value,
        currency: document.getElementById('productCurrency').value,
        category: document.getElementById('productCategory').value,
        city: document.getElementById('productCity').value,
        location: document.getElementById('productLocation').value.trim(),
        color: document.getElementById('productColor').value,
        condition: document.getElementById('productCondition').value
    };

    console.log('Form data:', formData);

    // Handle images
    for (let i = 1; i <= 3; i++) {
        const file = document.getElementById(`image${i}`).files[0];
        if (file) {
            console.log(`Processing image ${i}:`, file.name);
            const base64 = await fileToBase64(file);
            formData[`image${i}`] = base64;
        }
    }

    try {
        showLoading();
        console.log('Sending request to /api/products');
        
        const response = await apiCall('/api/products', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        console.log('Response received:', response);
        showToast('تم نشر المنتج بنجاح!', 'success');
        closePostProductModal();
        loadProducts(); // Reload products
    } catch (error) {
        console.error('Error submitting form:', error);
        showToast('فشل في نشر المنتج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
});

// Add click event listener to submit button for debugging
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submitProductBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('Submit button clicked');
            // Don't prevent default here, let the form handle it
        });
    }
    
    // Test if form exists
    const form = document.getElementById('postProductForm');
    if (form) {
        console.log('Form found and ready');
    } else {
        console.error('Form not found!');
    }
    
    // Set current user ID for JavaScript
    {% if user %}
    window.currentUserId = {{ user.id }};
    {% else %}
    window.currentUserId = null;
    {% endif %}
});

// Filter Functions
function applyFilters() {
    console.log('Applying filters...');
    currentPage = 1;
    loadProducts();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('cityFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    applyFilters();
}

// Load Products
async function loadProducts() {
    if (isLoading) return;
    
    isLoading = true;
    
    const params = new URLSearchParams({
        page: currentPage,
        limit: 10
    });

    const search = document.getElementById('searchInput').value;
    const category = document.getElementById('categoryFilter').value;
    const city = document.getElementById('cityFilter').value;
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;

    console.log('Filter values:', { search, category, city, minPrice, maxPrice, selectedCategory });

    if (search) params.append('search', search);
    
    // Use selected category from slider if not 'all', otherwise use sidebar filter
    if (selectedCategory !== 'all') {
        params.append('category', selectedCategory);
    } else if (category) {
        params.append('category', category);
    }
    
    if (city) params.append('city', city);
    if (minPrice) params.append('min_price', minPrice);
    if (maxPrice) params.append('max_price', maxPrice);

    console.log('API URL:', `/api/products?${params.toString()}`);

    try {
        // Show loading indicator
        if (currentPage === 1) {
            document.getElementById('productsFeed').innerHTML = `
                <div class="flex justify-center items-center py-12">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
                    <span class="mr-3 text-slate-600 dark:text-slate-400">جاري التحميل...</span>
                </div>
            `;
        }
        
        const response = await apiCall(`/api/products?${params.toString()}`);
        
        if (currentPage === 1) {
            document.getElementById('productsFeed').innerHTML = '';
        }
        
        renderProducts(response.products);
        
        // Show results count for filtered results
        const hasFilters = search || category || city || minPrice || maxPrice;
        if (hasFilters && currentPage === 1) {
            showToast(`تم العثور على ${response.products.length} منتج`, 'success');
        }
        
        if (response.products.length < 10) {
            document.querySelector('button[onclick="loadMoreProducts()"]').style.display = 'none';
        } else {
            document.querySelector('button[onclick="loadMoreProducts()"]').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading products:', error);
        if (currentPage === 1) {
            document.getElementById('productsFeed').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <p class="text-red-500 text-lg">حدث خطأ في تحميل المنتجات</p>
                    <p class="text-slate-600 dark:text-slate-400 mt-2">يرجى المحاولة مرة أخرى</p>
                </div>
            `;
        }
        showToast('فشل في تحميل المنتجات: ' + error.message, 'error');
    } finally {
        isLoading = false;
    }
}

function loadMoreProducts() {
    currentPage++;
    loadProducts();
}

function renderProducts(products) {
    const container = document.getElementById('productsFeed');
    
    products.forEach(product => {
        const productElement = createProductElement(product);
        container.appendChild(productElement);
    });
}

function createProductElement(product) {
    const div = document.createElement('div');
    div.className = 'bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-white/20 dark:border-slate-700/20 overflow-hidden';
    
    const images = [];
    if (product.hasImages.image1) images.push(`/api/products/image/${product.id}/1`);
    if (product.hasImages.image2) images.push(`/api/products/image/${product.id}/2`);
    if (product.hasImages.image3) images.push(`/api/products/image/${product.id}/3`);
    
    const imageGrid = images.map((src, index) => `
        <div class="aspect-square bg-gray-100 dark:bg-slate-700 rounded-xl overflow-hidden">
            <img src="${src}" alt="${product.title}" 
                 class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-300"
                 onclick="openImageModal('${src}')">
        </div>
    `).join('');
    
    div.innerHTML = `
        <div class="p-6 border-b border-gray-200 dark:border-slate-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center overflow-hidden">
                        <img src="/api/profile/image/${product.seller.id}/profile" 
                             alt="${product.seller.name}" 
                             class="w-full h-full object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">${product.seller.name}</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400">${formatDate(product.createdAt)}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-cyan-100 dark:bg-cyan-900 text-cyan-800 dark:text-cyan-200 px-3 py-1 rounded-full text-sm font-medium">
                        ${product.categoryDisplay}
                    </span>
                    <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-medium">
                        ${product.statusDisplay}
                    </span>
                </div>
            </div>
        </div>

        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        ${imageGrid}
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">${product.title}</h2>
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">${product.description}</p>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600 dark:text-slate-400">السعر:</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${product.price}</span>
                                <span class="text-sm text-slate-600 dark:text-slate-400">${product.currencyDisplay}</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600 dark:text-slate-400">المدينة:</span>
                            <span class="text-slate-800 dark:text-white font-medium">${product.city}</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600 dark:text-slate-400">الموقع:</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-slate-800 dark:text-white font-medium">${product.location}</span>
                                <button onclick="openGoogleMaps('${product.location}, ${product.city}, Iraq')" 
                                        class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                                        title="عرض على خرائط جوجل">
                                    <i class="fas fa-map-marker-alt text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${product.color ? `
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600 dark:text-slate-400">اللون:</span>
                            <span class="text-slate-800 dark:text-white font-medium">${product.color}</span>
                        </div>
                        ` : ''}
                        
                        ${product.condition ? `
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600 dark:text-slate-400">الحالة:</span>
                            <span class="text-slate-800 dark:text-white font-medium">${product.condition}</span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="flex space-x-3 pt-4">
                        ${getProductButtons(product)}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function contactSeller(sellerId) {
    window.location.href = `/chat/${sellerId}`;
}

function viewProfile(userId) {
    window.location.href = `/profile/${userId}`;
}

function getProductButtons(product) {
    // Check if current user is the seller (you'll need to pass current user ID from backend)
    const currentUserId = getCurrentUserId(); // We'll need to implement this
    
    if (currentUserId && currentUserId == product.seller.id) {
        // Show edit and delete buttons for product owner
        return `
            <button onclick="editProduct(${product.id})" class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 shadow-lg">
                <i class="fas fa-edit ml-2"></i>تعديل المنتج
            </button>
            <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300">
                <i class="fas fa-trash"></i>
            </button>
        `;
    } else {
        // Show contact and follow buttons for other users
        return `
            <button onclick="contactSeller(${product.seller.id})" class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 shadow-lg">
                <i class="fas fa-comment ml-2"></i>تواصل مع البائع
            </button>
            <button onclick="toggleFollow(${product.seller.id})" class="bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 px-4 py-3 rounded-xl font-medium transition-all duration-300">
                <i class="fas fa-user-plus"></i>
            </button>
        `;
    }
}

function getCurrentUserId() {
    // This should be set from the backend when the page loads
    return window.currentUserId || null;
}

function editProduct(productId) {
    // Open edit modal or redirect to edit page
    showToast('ميزة التعديل قيد التطوير', 'info');
    // TODO: Implement edit functionality - could open a modal with pre-filled form
}

async function deleteProduct(productId) {
    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        try {
            showLoading();
            const response = await apiCall(`/api/products/${productId}`, {
                method: 'DELETE'
            });
            
            showToast('تم حذف المنتج بنجاح', 'success');
            loadProducts(); // Reload the products list
        } catch (error) {
            console.error('Error deleting product:', error);
            showToast('فشل في حذف المنتج: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
}

function openGoogleMaps(address) {
    const encodedAddress = encodeURIComponent(address);
    const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
    window.open(googleMapsUrl, '_blank');
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        showToast('المتصفح لا يدعم تحديد الموقع', 'error');
        return;
    }

    showLoading();
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            
            // Use reverse geocoding to get address from coordinates
            reverseGeocode(latitude, longitude);
        },
        function(error) {
            hideLoading();
            let errorMessage = 'فشل في الحصول على الموقع';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'تم رفض إذن الوصول للموقع';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'معلومات الموقع غير متاحة';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'انتهت مهلة طلب الموقع';
                    break;
            }
            
            showToast(errorMessage, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

function reverseGeocode(latitude, longitude) {
    // Using Google Geocoding API (you'll need to get an API key)
    // For now, we'll use a simple approach with OpenStreetMap Nominatim
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ar`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data && data.display_name) {
                // Extract relevant parts of the address
                let address = data.display_name;
                
                // Clean up the address for better readability
                address = address.replace(/، العراق$/, ''); // Remove "، Iraq" at the end
                address = address.replace(/، محافظة [^،]*$/, ''); // Remove governorate info
                
                // Set the address in the input field
                document.getElementById('productLocation').value = address;
                showToast('تم الحصول على الموقع بنجاح!', 'success');
            } else {
                // Fallback: use coordinates if address lookup fails
                const fallbackAddress = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                document.getElementById('productLocation').value = fallbackAddress;
                showToast('تم الحصول على الإحداثيات، يمكنك تعديل العنوان', 'info');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Geocoding error:', error);
            
            // Fallback: use coordinates
            const fallbackAddress = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            document.getElementById('productLocation').value = fallbackAddress;
            showToast('تم الحصول على الإحداثيات، يمكنك تعديل العنوان', 'info');
        });
}

function convertCurrency() {
    const priceInput = document.getElementById('productPrice');
    const currencySelect = document.getElementById('productCurrency');
    const currentPrice = parseFloat(priceInput.value);
    
    if (!currentPrice || currentPrice <= 0) {
        showToast('يرجى إدخال سعر صحيح أولاً', 'error');
        return;
    }
    
    const currentCurrency = currencySelect.value;
    let newPrice, newCurrency, message;
    
    // Exchange rate: 1 USD = 1500 IQD (approximate rate, you can update this)
    const exchangeRate = 1500;
    
    if (currentCurrency === 'IQD') {
        newPrice = (currentPrice / exchangeRate).toFixed(2);
        newCurrency = 'USD';
        message = `تم تحويل ${currentPrice} دينار عراقي إلى ${newPrice} دولار أمريكي`;
    } else {
        newPrice = (currentPrice * exchangeRate).toFixed(0);
        newCurrency = 'IQD';
        message = `تم تحويل ${currentPrice} دولار أمريكي إلى ${newPrice} دينار عراقي`;
    }
    
    priceInput.value = newPrice;
    currencySelect.value = newCurrency;
    showToast(message, 'success');
}

// Test function to manually submit form
function testFormSubmission() {
    console.log('Testing form submission...');
    
    // Fill in some test data
    document.getElementById('productTitle').value = 'Test Product';
    document.getElementById('productDescription').value = 'Test Description';
    document.getElementById('productPrice').value = '100';
    document.getElementById('productCurrency').value = 'IQD';
    document.getElementById('productCategory').value = 'other';
    document.getElementById('productCity').value = 'بغداد';
    document.getElementById('productLocation').value = 'Test Location';
    
    // Trigger form submission
    const form = document.getElementById('postProductForm');
    if (form) {
        form.dispatchEvent(new Event('submit'));
    } else {
        console.error('Form not found for testing');
    }
}

// Test function for filters
function testFilters() {
    console.log('Testing filters...');
    
    // Set some test filter values
    document.getElementById('searchInput').value = 'سيارة';
    document.getElementById('categoryFilter').value = 'car';
    document.getElementById('cityFilter').value = 'بغداد';
    document.getElementById('minPrice').value = '1000';
    document.getElementById('maxPrice').value = '50000';
    
    // Apply filters
    applyFilters();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA') + ' ' + date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
}

// Home Page Seller Search functionality
async function searchHomeSellers(query) {
    if (query.length < 2) {
        document.getElementById('homeSellerSearchResults').innerHTML = '';
        return;
    }
    
    try {
        const response = await apiCall(`/api/search-sellers?q=${encodeURIComponent(query)}`);
        
        if (response.sellers && response.sellers.length > 0) {
            displayHomeSellerResults(response.sellers);
        } else {
            document.getElementById('homeSellerSearchResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لم يتم العثور على بائعين</p>';
        }
    } catch (error) {
        console.error('Home seller search error:', error);
        document.getElementById('homeSellerSearchResults').innerHTML = '<p class="text-red-500 text-center py-4">حدث خطأ أثناء البحث</p>';
    }
}

function displayHomeSellerResults(sellers) {
    const resultsContainer = document.getElementById('homeSellerSearchResults');
    
    const sellersHtml = sellers.map(seller => `
        <div class="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 border border-gray-200 dark:border-slate-600 hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">
            <div class="flex items-center space-x-4">
                <div class="h-12 w-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center overflow-hidden">
                    <img src="/api/profile/image/${seller.id}/profile" 
                         alt="${seller.name}" 
                         class="w-full h-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-slate-800 dark:text-white">${seller.name}</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">${seller.email}</p>
                    ${seller.isVerified ? '<span class="text-xs text-green-500"><i class="fas fa-check-circle ml-1"></i>مؤكد</span>' : ''}
                </div>
                <div class="flex space-x-2">
                    <button onclick="viewProfile(${seller.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user ml-1"></i>الملف
                    </button>
                    <button onclick="contactSeller(${seller.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-comment ml-1"></i>رسالة
                    </button>
                    <button onclick="toggleFollow(${seller.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = sellersHtml;
}

function clearHomeSearch() {
    document.getElementById('homeSellerSearchInput').value = '';
    document.getElementById('homeSellerSearchResults').innerHTML = '';
}

// Seller Search functionality (for sidebar)
async function searchSellers(query) {
    if (query.length < 2) {
        document.getElementById('sellerSearchResults').innerHTML = '';
        return;
    }
    
    try {
        const response = await apiCall(`/api/search-sellers?q=${encodeURIComponent(query)}`);
        
        if (response.sellers && response.sellers.length > 0) {
            displaySellerResults(response.sellers);
        } else {
            document.getElementById('sellerSearchResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">لم يتم العثور على بائعين</p>';
        }
    } catch (error) {
        console.error('Seller search error:', error);
        document.getElementById('sellerSearchResults').innerHTML = '<p class="text-red-500 text-center py-4">حدث خطأ أثناء البحث</p>';
    }
}

function displaySellerResults(sellers) {
    const resultsContainer = document.getElementById('sellerSearchResults');
    
    const sellersHtml = sellers.map(seller => `
        <div class="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 border border-gray-200 dark:border-slate-600">
            <div class="flex items-center space-x-4">
                <div class="h-12 w-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center overflow-hidden">
                    <img src="/api/profile/image/${seller.id}/profile" 
                         alt="${seller.name}" 
                         class="w-full h-full object-cover"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fas fa-user text-white text-lg" style="display: none;"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-slate-800 dark:text-white">${seller.name}</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">${seller.email}</p>
                    ${seller.isVerified ? '<span class="text-xs text-green-500"><i class="fas fa-check-circle ml-1"></i>مؤكد</span>' : ''}
                </div>
                <div class="flex space-x-2">
                    <button onclick="viewProfile(${seller.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user ml-1"></i>الملف
                    </button>
                    <button onclick="contactSeller(${seller.id})" class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-comment ml-1"></i>رسالة
                    </button>
                    <button onclick="toggleFollow(${seller.id})" class="bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-300 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = sellersHtml;
}

// Follow/Unfollow functionality
async function toggleFollow(userId) {
    try {
        // Check current follow status
        const statusResponse = await apiCall(`/api/follow-status/${userId}`);
        
        if (!statusResponse.success) {
            showToast('فشل في جلب حالة المتابعة: ' + statusResponse.error, 'error');
            return;
        }
        
        const isFollowing = statusResponse.isFollowing;
        let response;
        
        if (isFollowing) {
            response = await apiCall(`/api/unfollow/${userId}`, { method: 'POST' });
        } else {
            response = await apiCall(`/api/follow/${userId}`, { method: 'POST' });
        }
        
        if (response.success) {
            showToast(response.message, 'success');
        } else {
            showToast(response.error || 'حدث خطأ أثناء المتابعة', 'error');
        }
        
    } catch (error) {
        console.error('Follow toggle error:', error);
        showToast(error.message || 'حدث خطأ أثناء المتابعة', 'error');
    }
}

// Category Filtering
let selectedCategory = 'all';

function filterByCategory(category) {
    selectedCategory = category;
    
        // Update button styles
        document.querySelectorAll('.category-btn').forEach(btn => {
            const btnCategory = btn.getAttribute('data-category');
            if (btnCategory === category) {
                // Active state
                btn.className = btn.className.replace('bg-white dark:bg-slate-700', 'bg-gradient-to-r from-emerald-500 to-green-600')
                    .replace('text-gray-700 dark:text-gray-300', 'text-white')
                    .replace('border-2 border-gray-200 dark:border-slate-600', '')
                    .replace('hover:bg-emerald-50 dark:hover:bg-emerald-900/20', 'hover:from-emerald-600 hover:to-green-700')
                    .replace('hover:text-emerald-600 dark:hover:text-emerald-400', '')
                    .replace('hover:border-emerald-300 dark:hover:border-emerald-600', '');
            } else {
                // Inactive state
                btn.className = btn.className.replace('bg-gradient-to-r from-emerald-500 to-green-600', 'bg-white dark:bg-slate-700')
                    .replace('text-white', 'text-gray-700 dark:text-gray-300')
                    .replace('hover:from-emerald-600 hover:to-green-700', 'hover:bg-emerald-50 dark:hover:bg-emerald-900/20')
                    .replace('hover:text-emerald-600 dark:hover:text-emerald-400', 'hover:text-emerald-600 dark:hover:text-emerald-400');
                if (!btn.className.includes('border-2')) {
                    btn.className += ' border-2 border-gray-200 dark:border-slate-600 hover:border-emerald-300 dark:hover:border-emerald-600';
                }
            }
        });
    
    // Reset pagination and load products
    currentPage = 1;
    loadProducts();
    
    // Show loading state
    showToast(`جاري تحميل منتجات ${category === 'all' ? 'الكل' : getCategoryName(category)}...`, 'info');
}

function getCategoryName(category) {
    const names = {
        'all': 'الكل',
        'car': 'سيارات',
        'home_rental': 'إيجار منازل',
        'apartment_rental': 'إيجار شقق',
        'job': 'وظائف',
        'laptop': 'لابتوب',
        'electronics': 'إلكترونيات',
        'fashion': 'أزياء',
        'furniture': 'أثاث',
        'books': 'كتب',
        'sports': 'رياضة',
        'other': 'أخرى'
    };
    return names[category] || category;
}

// Hero Slider Functions
let currentSlide = 0;
const totalSlides = {{ sliderImages|length > 0 ? sliderImages|length : 1 }};

function changeSlide(slideIndex) {
    const slides = document.querySelectorAll('.slider-slide');
    const dots = document.querySelectorAll('.slider-dot');
    
    // Remove active class from all slides and dots
    slides.forEach(slide => slide.classList.remove('active', 'opacity-100'));
    dots.forEach(dot => dot.classList.remove('active'));
    
    // Add active class to current slide and dot
    slides[slideIndex].classList.add('active', 'opacity-100');
    dots[slideIndex].classList.add('active');
    
    currentSlide = slideIndex;
}

function nextSlide() {
    currentSlide = (currentSlide + 1) % totalSlides;
    changeSlide(currentSlide);
}

function previousSlide() {
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    changeSlide(currentSlide);
}

// Auto-slide functionality
function startAutoSlide() {
    setInterval(() => {
        nextSlide();
    }, 5000); // Change slide every 5 seconds
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set current user ID for JavaScript functions
    {% if user %}
    window.currentUserId = {{ user.id }};
    {% else %}
    window.currentUserId = null;
    {% endif %}
    
    // Initialize slider
    startAutoSlide();
    
    loadProducts();
    
    // Add filter input listeners
    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('cityFilter').addEventListener('change', applyFilters);
    document.getElementById('minPrice').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('maxPrice').addEventListener('input', debounce(applyFilters, 500));
    
    // Add seller search listener (sidebar)
    document.getElementById('sellerSearchInput').addEventListener('input', debounce(function(e) {
        searchSellers(e.target.value);
    }, 300));
    
    // Add home seller search listener
    document.getElementById('homeSellerSearchInput').addEventListener('input', debounce(function(e) {
        searchHomeSellers(e.target.value);
    }, 300));
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}