{% extends 'base.html.twig' %}

{% block title %}جميع المنتجات - شورجي{% endblock %}

{% block body %}
{% include 'components/home_navigation.html.twig' %}

<style>
    /* Custom animations and styles */
    .glass {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .glass-dark {
        background: rgba(15, 23, 42, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .product-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .product-card:hover {
        transform: translateY(-4px) scale(1.02);
    }
    
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #2563eb, #7c3aed);
    }
    
    .line-clamp-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
    }
    
    .line-clamp-3 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-green-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-th-large text-emerald-500 ml-3"></i>
                جميع المنتجات
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                اكتشف وابحث عن المنتجات من البائعين في منطقتك
            </p>
        </div>

        <!-- Advanced Search and Filters -->
        {% include 'products/advanced-filters.html.twig' %}

        <!-- Products Grid -->
        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/20 p-8">
            <!-- Results Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-box text-emerald-500 ml-2"></i>المنتجات المتاحة
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-1" id="resultsCount">جاري التحميل...</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="bg-emerald-100 dark:bg-emerald-900 text-emerald-800 dark:text-emerald-200 px-4 py-2 rounded-2xl font-semibold" id="productsCount">
                        0 منتج
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                    <span class="text-gray-600 dark:text-gray-400 font-medium">جاري تحميل المنتجات...</span>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-16 hidden">
                <div class="w-24 h-24 bg-gradient-to-br from-gray-400 to-gray-500 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-lg">
                    <i class="fas fa-search text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-600 dark:text-slate-300 mb-4">لا توجد منتجات</h3>
                <p class="text-gray-500 dark:text-slate-400 text-lg">لم يتم العثور على منتجات تطابق معايير البحث</p>
            </div>

            <!-- Products Grid -->
            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 sm:gap-6">
                <!-- Products will be loaded here -->
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex flex-wrap items-center justify-center mt-12 gap-2 sm:gap-4">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
let totalPages = 1;
let totalProducts = 0;
let isLoading = false;
let currentProducts = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    
    // Load messages count and start real-time updates
    loadMessagesCount();
    startRealTimeUpdates();
    
    // Sound notification functions
    function playNotificationSound() {
        try {
            // Create a simple notification sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (error) {
            console.log('Could not play notification sound:', error);
        }
    }
    
    function playMessageSound() {
        try {
            // Create a different sound for messages
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Two-tone message sound
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.05);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        } catch (error) {
            console.log('Could not play message sound:', error);
        }
    }
    
    // Add filter input listeners
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const cityFilter = document.getElementById('cityFilter');
    const priceRangeFilter = document.getElementById('priceRangeFilter');
    const dateFilter = document.getElementById('dateFilter');
    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');
    const sortBy = document.getElementById('sortBy');

    if (searchInput) {
        searchInput.addEventListener('input', debounce(applyAdvancedFilters, 500));
        console.log('Search input listener added');
    }
    if (categoryFilter) {
        categoryFilter.addEventListener('change', applyAdvancedFilters);
        console.log('Category filter listener added');
    }
    if (cityFilter) {
        cityFilter.addEventListener('change', applyAdvancedFilters);
        console.log('City filter listener added');
    }
    if (priceRangeFilter) {
        priceRangeFilter.addEventListener('change', applyAdvancedFilters);
        console.log('Price range filter listener added');
    }
    if (dateFilter) {
        dateFilter.addEventListener('change', applyAdvancedFilters);
        console.log('Date filter listener added');
    }
    if (minPrice) {
        minPrice.addEventListener('input', debounce(applyAdvancedFilters, 500));
        console.log('Min price listener added');
    }
    if (maxPrice) {
        maxPrice.addEventListener('input', debounce(applyAdvancedFilters, 500));
        console.log('Max price listener added');
    }
    if (sortBy) {
        sortBy.addEventListener('change', applyAdvancedFilters);
        console.log('Sort by listener added');
    }
});

// Load products with filters
async function loadProducts() {
    if (isLoading) return;
    
    isLoading = true;
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('pagination').classList.add('hidden');
    
    const params = new URLSearchParams();
    const search = document.getElementById('searchInput').value;
    const category = document.getElementById('categoryFilter').value;
    const city = document.getElementById('cityFilter').value;
    const priceRange = document.getElementById('priceRangeFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const minPriceValue = document.getElementById('minPrice').value;
    const maxPriceValue = document.getElementById('maxPrice').value;
    const sortByValue = document.getElementById('sortBy').value;
    
    // Basic filters
    if (search) params.append('search', search);
    if (category) params.append('category', category);
    if (city) params.append('city', city);
    if (sortByValue) params.append('sort', sortByValue);
    
    // Price range filter
    if (priceRange) {
        const [min, max] = priceRange.split('-');
        if (min) params.append('min_price', min);
        if (max && max !== '+') params.append('max_price', max);
    }
    
    // Custom price range (overrides price range filter)
    if (minPriceValue) params.append('min_price', minPriceValue);
    if (maxPriceValue) params.append('max_price', maxPriceValue);
    
    // Date filter
    if (dateFilter) {
        const now = new Date();
        let dateFrom;
        
        switch (dateFilter) {
            case 'today':
                dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
            case 'week':
                dateFrom = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
            case 'month':
                dateFrom = new Date(now.getFullYear(), now.getMonth(), 1);
                break;
            case '3months':
                dateFrom = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                break;
            case '6months':
                dateFrom = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                break;
            case 'year':
                dateFrom = new Date(now.getFullYear(), 0, 1);
                break;
        }
        
        if (dateFrom) {
            params.append('date_from', dateFrom.toISOString().split('T')[0]);
        }
    }
    
    params.append('page', currentPage);
    params.append('limit', 12);

    try {
        console.log('Loading products with filters:', params.toString());
        console.log('Filter values:', {
            search: document.getElementById('searchInput').value,
            category: document.getElementById('categoryFilter').value,
            city: document.getElementById('cityFilter').value,
            minPrice: document.getElementById('minPrice').value,
            maxPrice: document.getElementById('maxPrice').value,
            sortBy: document.getElementById('sortBy').value
        });
        
        const url = `/web/products?${params.toString()}`;
        console.log('API URL:', url);
        
        const response = await apiCall(url);
        console.log('Products API response:', response);
        
        if (response.products && response.products.length > 0) {
            currentProducts = response.products;
            console.log('Current products loaded:', currentProducts);
            renderProducts(response.products);
            updatePagination(response.pagination);
            document.getElementById('emptyState').classList.add('hidden');
            
            // Show success message if filters are applied
            const hasFilters = search || category || city || minPriceValue || maxPriceValue || sortByValue !== 'newest';
            if (hasFilters) {
                showToast(`تم العثور على ${response.products.length} منتج`, 'success');
            }
        } else {
            document.getElementById('productsGrid').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('pagination').classList.add('hidden');
            
            // Show no results message if filters are applied
            const hasFilters = search || category || city || minPriceValue || maxPriceValue || sortByValue !== 'newest';
            if (hasFilters) {
                showToast('لم يتم العثور على منتجات تطابق الفلاتر المحددة', 'warning');
            }
        }
        
        document.getElementById('productsCount').textContent = `${response.pagination.total} منتج`;
        document.getElementById('resultsCount').textContent = `عرض ${response.products.length} من ${response.pagination.total} منتج`;
        
    } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('productsGrid').innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="text-red-500 text-lg">حدث خطأ في تحميل المنتجات</p>
                <p class="text-slate-600 dark:text-slate-400 mt-2">يرجى المحاولة مرة أخرى</p>
            </div>
        `;
        showToast('فشل في تحميل المنتجات: ' + error.message, 'error');
    } finally {
        isLoading = false;
        document.getElementById('loadingState').classList.add('hidden');
    }
}

// Render products
function renderProducts(products) {
    const grid = document.getElementById('productsGrid');
    
    grid.innerHTML = products.map(product => `
        <div class="product-card bg-white dark:bg-slate-700 rounded-2xl shadow-md border border-gray-100 dark:border-slate-600 overflow-hidden hover:shadow-xl transition-all duration-300 group">
            <!-- Product Image -->
            <div class="relative h-48 bg-gray-100 dark:bg-slate-600 overflow-hidden">
                ${product.hasImages && product.hasImages.image1 ? 
                    `<img src="/api/products/image/${product.id}/1" alt="${product.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` :
                    ``
                }
                <div class="flex items-center justify-center text-gray-400 dark:text-slate-400 h-full" style="display: ${product.hasImages && product.hasImages.image1 ? 'none' : 'flex'};">
                    <div class="text-center">
                        <i class="fas fa-image text-4xl mb-2"></i>
                        <p class="text-sm">لا توجد صورة</p>
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div class="absolute top-3 right-3">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(product.status)}">
                        ${product.statusDisplay || 'متاح'}
                    </span>
                </div>
            </div>
            
            <!-- Product Info -->
            <div class="p-5">
                <!-- Category -->
                <div class="mb-3">
                    <span class="inline-block bg-gray-100 dark:bg-slate-600 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full text-xs font-medium">
                        ${product.categoryDisplay || product.category}
                    </span>
                </div>
                
                <!-- Title -->
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 line-clamp-2 leading-tight">${product.title}</h3>
                
                <!-- Price -->
                <div class="mb-3">
                    <span class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                        ${product.price} ${product.currencyDisplay || product.currency}
                    </span>
                </div>
                
                <!-- Description -->
                <p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-2 mb-4 leading-relaxed">${product.description}</p>
                
                <!-- Location and Date -->
                <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-map-marker-alt ml-1"></i>
                        <span>${product.city}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-calendar ml-1"></i>
                        <span>${formatDate(product.createdAt)}</span>
                    </div>
                </div>
                
                <!-- Seller -->
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
                        <img src="/api/user/avatar/${product.seller?.id || 0}" 
                             alt="${product.seller?.name || 'غير محدد'}" 
                             class="w-full h-full object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <i class="fas fa-user text-white text-xs" style="display: none;"></i>
                    </div>
                    <div class="mr-3">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${product.seller?.name || 'غير محدد'}</p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-2">
                    <button onclick="contactSellerWithProduct(${product.id}, ${product.seller?.id || 0})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 text-sm" title="Seller ID: ${product.seller?.id || 'N/A'}">
                        <i class="fas fa-comments ml-1"></i>رسالة
                    </button>
                    <button onclick="viewSellerProfile(${product.seller?.id || 0})" class="px-4 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors duration-200 text-sm">
                        <i class="fas fa-user"></i>
                    </button>
                    <button onclick="viewProduct(${product.id})" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors duration-200 text-sm">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// View product function
function viewProduct(productId) {
    window.location.href = `/product/${productId}`;
}

// Get status color
function getStatusColor(status) {
    switch (status) {
        case 'available': return 'from-emerald-500 to-green-500';
        case 'sold': return 'from-red-500 to-pink-500';
        case 'reserved': return 'from-yellow-500 to-orange-500';
        default: return 'from-emerald-500 to-green-500';
    }
}

// Get status badge class
function getStatusBadgeClass(status) {
    switch (status) {
        case 'available': return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200';
        case 'sold': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        case 'reserved': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        default: return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200';
    }
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Update pagination
function updatePagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    totalPages = pagination.pages;
    totalProducts = pagination.total;
    currentPage = pagination.page;
    
    if (totalPages <= 1) {
        paginationDiv.classList.add('hidden');
        return;
    }
    
    paginationDiv.classList.remove('hidden');
    
    let paginationHTML = '';
    
    // Previous button
    if (currentPage > 1) {
        paginationHTML += `
            <button onclick="goToPage(${currentPage - 1})" 
                    class="px-4 py-2 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-slate-600 rounded-xl hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors">
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button onclick="goToPage(${i})" 
                    class="px-4 py-2 ${i === currentPage ? 'bg-emerald-500 text-white' : 'bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-300'} border border-gray-300 dark:border-slate-600 rounded-xl hover:bg-emerald-50 dark:hover:bg-slate-600 transition-colors">
                ${i}
            </button>
        `;
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHTML += `
            <button onclick="goToPage(${currentPage + 1})" 
                    class="px-4 py-2 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-slate-600 rounded-xl hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors">
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
    }
    
    paginationDiv.innerHTML = paginationHTML;
}

// Pagination functions
function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        loadProducts();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        goToPage(currentPage + 1);
    }
}

function previousPage() {
    if (currentPage > 1) {
        goToPage(currentPage - 1);
    }
}

// Apply advanced filters
function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    console.log('Current filter values:', {
        search: document.getElementById('searchInput')?.value || '',
        category: document.getElementById('categoryFilter')?.value || '',
        city: document.getElementById('cityFilter')?.value || '',
        priceRange: document.getElementById('priceRangeFilter')?.value || '',
        dateFilter: document.getElementById('dateFilter')?.value || '',
        minPrice: document.getElementById('minPrice')?.value || '',
        maxPrice: document.getElementById('maxPrice')?.value || '',
        sortBy: document.getElementById('sortBy')?.value || ''
    });
    currentPage = 1;
    loadProducts();
}

// Apply filters (legacy function for compatibility)
function applyFilters() {
    applyAdvancedFilters();
}

// Clear all filters
function clearAllFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('cityFilter').value = '';
    document.getElementById('priceRangeFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('sortBy').value = 'newest';
    
    applyAdvancedFilters();
}

// Clear filters (legacy function for compatibility)
function clearFilters() {
    clearAllFilters();
}

// Save filter preset
function saveFilterPreset() {
    const filters = {
        search: document.getElementById('searchInput').value,
        category: document.getElementById('categoryFilter').value,
        city: document.getElementById('cityFilter').value,
        priceRange: document.getElementById('priceRangeFilter').value,
        dateFilter: document.getElementById('dateFilter').value,
        minPrice: document.getElementById('minPrice').value,
        maxPrice: document.getElementById('maxPrice').value,
        sortBy: document.getElementById('sortBy').value
    };
    
    const presetName = prompt('أدخل اسم للفلاتر المحفوظة:');
    if (presetName) {
        localStorage.setItem(`filter_preset_${presetName}`, JSON.stringify(filters));
        showToast(`تم حفظ الفلاتر باسم: ${presetName}`, 'success');
    }
}

// API call function (using the one from base template)
async function apiCall(url, options = {}) {
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        credentials: 'same-origin' // Include cookies for session authentication
    };
    
    // Only use JWT token for /api endpoints, not for /web endpoints
    if (url.startsWith('/api/')) {
        const token = localStorage.getItem('jwt_token');
        if (token) {
            defaultOptions.headers['Authorization'] = `Bearer ${token}`;
        }
    }
    
    const response = await fetch(url, { ...defaultOptions, ...options });
    
    // Handle redirect responses (authentication required)
    if (response.redirected || response.status === 302) {
        throw new Error('Authentication required');
    }
    
    const data = await response.json();
    
    if (!response.ok) {
        throw new Error(data.error || 'An error occurred');
    }
    
    return data;
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Toast notification function
// Contact seller function
function contactSeller(sellerId) {
    if (sellerId && sellerId !== 0) {
        window.location.href = `/messages?seller=${sellerId}`;
    } else {
        showToast('معلومات البائع غير متوفرة', 'warning');
    }
}

// Contact seller with product details
function contactSellerWithProduct(productId, sellerId) {
    console.log('Contacting seller:', { productId, sellerId });
    console.log('Current products:', currentProducts);
    
    if (!sellerId || sellerId === 0) {
        showToast('معلومات البائع غير متوفرة', 'warning');
        return;
    }
    
    // Find the product details
    const product = currentProducts.find(p => p.id === productId);
    console.log('Found product:', product);
    
    if (!product) {
        showToast('معلومات المنتج غير متوفرة', 'warning');
        return;
    }
    
    // Create comprehensive product attachment data
    const productAttachment = {
        productId: product.id,
        productName: product.title,
        productPrice: `${product.price} ${product.currencyDisplay || product.currency}`,
        productImage: product.hasImages?.image1 ? `/api/products/image/${product.id}/1` : null,
        productCategory: product.categoryDisplay || product.category,
        productCity: product.city,
        productDescription: product.description || '',
        productCondition: product.condition || 'جديد',
        sellerName: product.seller?.firstName + ' ' + product.seller?.lastName || 'البائع',
        sellerId: product.seller?.id || sellerId
    };
    
    console.log('Product attachment:', productAttachment);
    
    // Show loading toast
    showToast('جاري تحضير الرسالة...', 'info');
    
    // Encode the product data as URL parameter
    const productData = encodeURIComponent(JSON.stringify(productAttachment));
    
    console.log('Encoded product data:', productData);
    console.log('Redirecting to:', `/messages?seller=${sellerId}&product=${productData}`);
    
    // Redirect to messages with product attachment
    window.location.href = `/messages?seller=${sellerId}&product=${productData}`;
}

// View seller profile function
function viewSellerProfile(sellerId) {
    if (sellerId && sellerId !== 0) {
        window.location.href = `/profile/${sellerId}`;
    } else {
        showToast('معلومات البائع غير متوفرة', 'warning');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-2xl text-white font-medium shadow-2xl transform transition-all duration-300 ${
        type === 'success' ? 'bg-emerald-500' : 
        type === 'error' ? 'bg-red-500' : 
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
    }, 100);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Messages count and real-time updates
async function loadMessagesCount() {
    try {
        console.log('Loading messages count...');
        const response = await apiCall('/web/conversations');
        const count = response.unreadCount || 0;
        console.log('Messages count received:', count);
        updateMessagesBadge(count);
    } catch (error) {
        console.error('Error loading messages count:', error);
        updateMessagesBadge(0);
    }
}

function updateMessagesBadge(count) {
    console.log('Updating messages badge with count:', count);
    const badge = document.getElementById('messagesCount');
    console.log('Badge element found:', badge);
    
    if (badge) {
        const previousCount = parseInt(badge.textContent) || 0;
        
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
            console.log('Badge shown with count:', count);
            
            // Play sound if count increased (new message)
            if (count > previousCount) {
                playMessageSound();
            }
        } else {
            badge.classList.add('hidden');
            console.log('Badge hidden (count is 0)');
        }
    } else {
        console.error('Messages badge element not found!');
    }
}


// Real-time updates using polling
let lastMessageCount = 0;
function startRealTimeUpdates() {
    // Update counts every 30 seconds
    setInterval(() => {
        loadMessagesCount();
    }, 30000);
    
    // Check for new messages every 10 seconds for toast notifications
    setInterval(() => {
        checkForNewMessages();
    }, 10000);
}

// Check for new messages and show toast notifications
async function checkForNewMessages() {
    try {
        console.log('Checking for new messages (products page)');
        const response = await apiCall('/web/conversations');
        const currentCount = response.unreadCount || 0;
        console.log('Current message count:', currentCount, 'Last count:', lastMessageCount);
        
        // If there are new messages (count increased)
        if (currentCount > lastMessageCount && lastMessageCount > 0) {
            const newMessages = currentCount - lastMessageCount;
            console.log('New messages detected:', newMessages);
            showToast(`لديك ${newMessages} رسالة جديدة`, 'info');
        }
        
        lastMessageCount = currentCount;
        updateMessagesBadge(currentCount);
    } catch (error) {
        console.error('Error checking for new messages:', error);
        if (error.message === 'Authentication required') {
            console.log('User not authenticated, stopping real-time updates');
        }
    }
}
</script>
{% endblock %}
