name: Deploy Shorje Platform to Railway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, zip, curl, gd, imagick
        coverage: none
        
    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
      
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ~/.composer/cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
          
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install Node dependencies
      run: |
        cd shorje-api
        npm install
        
    - name: Build assets
      run: |
        cd shorje-api
        npm run build
        
    - name: Clear Symfony cache
      run: |
        cd shorje-api
        php bin/console cache:clear --env=prod --no-debug
        php bin/console cache:warmup --env=prod --no-debug
        
    - name: Create deployment package
      run: |
        cd shorje-api
        tar -czf ../shorje-deployment.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='var/cache' \
          --exclude='var/log' \
          --exclude='tests' \
          --exclude='.env.local' \
          --exclude='.env.test' \
          .
          
    - name: Upload deployment package
      uses: actions/upload-artifact@v3
      with:
        name: shorje-deployment
        path: shorje-deployment.tar.gz
        
    - name: Deploy to Railway
      if: github.ref == 'refs/heads/main'
      uses: railwayapp/railway-deploy@v1
      with:
        railway-token: ${{ secrets.RAILWAY_TOKEN }}
        service: shorje-platform
        
    - name: Comment deployment URL
      if: github.ref == 'refs/heads/main'
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ğŸš€ Deployment successful')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: `ğŸš€ **Deployment successful!**
              
              ğŸŒ **Live URL**: https://shorje-platform-production.up.railway.app
              
              ğŸ“‹ **Test the following features:**
              - âœ… Homepage with Arabic content
              - âœ… User registration and login
              - âœ… Contact form
              - âœ… Admin dashboard (admin@shorje.com)
              - âœ… Product management
              - âœ… Messaging system
              
              ğŸ”§ **Admin Credentials:**
              - Email: admin@shorje.com
              - Password: (check your local .env file)
              
              ğŸ“± **Share this link with friends for testing!**
              
              â° **Deployed at**: ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Baghdad' })}`
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš€ **Deployment successful!**
              
              ğŸŒ **Live URL**: https://shorje-platform-production.up.railway.app
              
              ğŸ“‹ **Test the following features:**
              - âœ… Homepage with Arabic content
              - âœ… User registration and login
              - âœ… Contact form
              - âœ… Admin dashboard (admin@shorje.com)
              - âœ… Product management
              - âœ… Messaging system
              
              ğŸ”§ **Admin Credentials:**
              - Email: admin@shorje.com
              - Password: (check your local .env file)
              
              ğŸ“± **Share this link with friends for testing!**
              
              â° **Deployed at**: ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Baghdad' })}`
            });
          }
